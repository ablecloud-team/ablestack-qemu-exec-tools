#!/bin/bash
#
# ablestack-qemu-exec-tools cloud_init_auto.sh
#
# Copyright 2025 ABLECLOUD
#
# Licensed under the Apache License, Version 2.0 (the "License");
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

LIBDIR="/usr/libexec/ablestack-qemu-exec-tools"
source "$LIBDIR/cloud_init_common.sh"

# ----------------------------------------------------------------------
# cloud-initì´ ë„¤íŠ¸ì›Œí¬(IP í• ë‹¹) ì´í›„ì— ì‹¤í–‰ë˜ë„ë¡ Unit override ìƒì„±
#   - /etc/systemd/system/cloud-init.service.d/ablestack-network-online.conf
#     ë¥¼ ë§Œë“¤ì–´ì„œ,
#
#       After=network-online.target
#
#     ë¥¼ ì„ ì–¸
# ----------------------------------------------------------------------
ensure_cloud_init_after_network_online() {
    local dropin_dir="/etc/systemd/system/cloud-init.service.d"
    local override="${dropin_dir}/ablestack-network-online.conf"

    mkdir -p "$dropin_dir"

    cat > "$override" <<'EOF'
# Generated by ablestack-qemu-exec-tools cloud_init_auto.sh
# Ensure cloud-init "Network Stage" runs after full network-online.target
# so that metadata from virtual router (not ConfigDrive) is available.

[Unit]
# ê¸°ì¡´ cloud-init.serviceì˜ Before=network-online.target ì„¤ì •ì„ ì œê±°
Before=sshd-keygen.service sshd.service systemd-user-session.service
EOF

    # systemd ì— ì„¤ì • ë°˜ì˜
    if command -v systemctl >/dev/null 2>&1; then
        systemctl daemon-reload || true
    fi
}

msg "[INFO] cloud-init ì„¤ì¹˜ í™•ì¸ ì¤‘..." "[INFO] Checking cloud-init installation..."
if check_cloud_init_installed; then
    msg "[INFO] cloud-initì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤." "[INFO] cloud-init is already installed."
else
    msg "[INFO] cloud-initì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šì•„ ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤." \
        "[INFO] cloud-init is not installed, so installation will proceed."
    install_cloud_init || { msg "[ERROR] cloud-init ì„¤ì¹˜ ì‹¤íŒ¨!" "[ERROR] cloud-init installation failed!"; exit 1; }
fi

msg "[INFO] metadata providerë¥¼ ConfigDrive, CloudStack, Noneìœ¼ë¡œ ì§€ì •í•©ë‹ˆë‹¤..." \
    "[INFO] Specify metadata provider as ConfigDrive, CloudStack, None..."
set_metadata_provider_configdrive_cloudstack

msg "[INFO] cloud.cfgì—ì„œ users í•­ëª©ì„ rootë¡œ ì„¤ì •í•©ë‹ˆë‹¤..." \
    "[INFO] Set users entry to root in cloud.cfg..."
patch_cloud_cfg_users_root

msg "[INFO] set_hostname, set_passwords, ssh, runcmd í•­ëª©ë§Œ ë§¤ ë¶€íŒ…(always) ì‹¤í–‰ìœ¼ë¡œ íŒ¨ì¹˜í•©ë‹ˆë‹¤..." \
    "[INFO] Patch only set_hostname, set_passwords, ssh, runcmd items to always run on every boot..."
patch_cloud_init_and_config_modules_frequency_partial

# ğŸ”½ ì—¬ê¸°ì„œ cloud-init Network Stageê°€ network-online.target ì´í›„ ì‹¤í–‰ë˜ë„ë¡ override ì ìš©
msg "[INFO] cloud-init Network Stageê°€ network-online.target ì´í›„ ì‹¤í–‰ë˜ë„ë¡ Unit overrideë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤..." \
    "[INFO] Configure cloud-init Network Stage to start after network-online.target via systemd override..."
ensure_cloud_init_after_network_online

# OSë³„ ì¡°ê±´ ì²˜ë¦¬
if [ -f /etc/os-release ]; then
    . /etc/os-release
    case "$ID" in
        ubuntu|debian)
            msg "[INFO] Ubuntu/Debian detected: shutdown clean ì„œë¹„ìŠ¤ ë“±ë¡ì„ ê±´ë„ˆëœë‹ˆë‹¤." \
                "[INFO] Ubuntu/Debian detected: skipping setup_cloud_init_clean_on_shutdown."
            ;;
        *)
            msg "[INFO] cloud-init ì´ˆê¸°í™” ì„¤ì •ì„ ê°€ìƒë¨¸ì‹  ì…§ë‹¤ìš´ ì‹œì— ì¬ì„¤ì •(clean) í•˜ë„ë¡ ì„œë¹„ìŠ¤ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤." \
                "[INFO] Register a service to reset (clean) cloud-init initialization settings when the virtual machine is shut down."
            setup_cloud_init_clean_on_shutdown
            ;;
    esac
fi

print_final_message
exit 0