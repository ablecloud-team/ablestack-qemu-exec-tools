name: WinPE Test Build (manual)

on:
  workflow_dispatch:
    inputs:
      architecture:
        description: "WinPE architecture"
        required: true
        default: "amd64"
        type: choice
        options: ["amd64"]
      iso_suffix:
        description: "Suffix for test ISO (e.g. test-20260116 or pr-123)"
        required: true
        default: "test"
        type: string
      retention_days:
        description: "Artifact retention days"
        required: true
        default: "14"
        type: string

permissions:
  contents: read

jobs:
  build:
    uses: ./.github/workflows/build-winpe-core.yml
    with:
      architecture: ${{ inputs.architecture }}
      # NOTE: WinPE bootstrap detects "test" builds via ISO volume label.
      # Keep "-test" in the base name so debug ISOs do NOT shutdown the VM on exit.
      iso_base_name: "winpe-ablestack-v2k-test"
      iso_suffix: ${{ inputs.iso_suffix }}
      # Build raw ISO first, then inject TEST_MODE marker in this workflow.
      artifact_name: "winpe-iso-test-raw"
      retention_days: ${{ inputs.retention_days }}

  mark_test_mode:
    name: Add TEST_MODE marker to ISO
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download raw ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: winpe-iso-test-raw
          path: raw

      - name: Ensure xorriso is available
        run: |
          sudo apt-get update -y
          sudo apt-get install -y xorriso

      - name: Create TEST_MODE marker
        run: |
          set -euo pipefail
          mkdir -p add/ablestack
          echo "TEST_MODE=1" > add/ablestack/TEST_MODE

      - name: Inject marker into ISO (preserve boot)
        run: |
          set -euo pipefail
          ISO_IN="$(ls -1 raw/*.iso | head -n 1)"
          ISO_OUT="winpe-ablestack-v2k-test-${{ inputs.iso_suffix }}.iso"
          # WinPE ISO often has hidden El-Torito/EFI boot images not stored as ISO data files.
          # Using "replay" tries to re-enable them as files and triggers SORRY(32).
          # Use "keep" to preserve original boot record as-is, while only adding the marker file.
          xorriso -indev "$ISO_IN" -outdev "$ISO_OUT" -boot_image any keep \
            -map add/ablestack/TEST_MODE /ablestack/TEST_MODE

          # quick boot info check (fails step if boot record is missing)
          xorriso -indev "$ISO_OUT" -report_el_torito as_mkisofs
          ls -l "$ISO_OUT"

      - name: Upload final ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: winpe-iso-test
          path: winpe-ablestack-v2k-test-${{ inputs.iso_suffix }}.iso
          retention-days: ${{ inputs.retention_days }}