name: WinPE Release Build

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    uses: ./.github/workflows/build-winpe-core.yml
    with:
      architecture: "amd64"
      iso_base_name: "winpe-ablestack-v2k"
      iso_suffix: ""                # 릴리즈는 suffix 없이 고정
      artifact_name: "winpe-iso-release"
      retention_days: 30

  attach:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: dist

      - name: List files
        shell: bash
        run: |
          ls -al dist

      - name: Attach assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # 어떤 태그 릴리즈에 붙일지 명시 (tag push 이벤트 기준)
          tag_name: ${{ github.ref_name }}
          # 릴리즈 본문/노트는 build.yml이 통합 생성(권장) → 여기서는 건드리지 않음
          generate_release_notes: false
          files: |
            dist/*.iso
            dist/SHA256SUMS
          # 산출물 누락 시 조기 실패(릴리즈 누락 방지)
          fail_on_unmatched_files: true