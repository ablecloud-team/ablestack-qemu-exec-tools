name: Build WinPE ISO (serverless)

on:
  workflow_dispatch:
    inputs:
      architecture:
        description: "WinPE architecture"
        required: true
        default: "amd64"
        type: choice
        options: ["amd64"]
      iso_name:
        description: "Output ISO base name"
        required: true
        default: "winpe-ablestack-v2k"
        type: string
  push:
    paths:
      - "winpe/**"
      - ".github/workflows/build-winpe.yml"
  release:
    types: [published]

permissions:
  contents: write   # for attaching assets to release (optional path)
  actions: read

jobs:
  build-winpe:
    runs-on: windows-latest
    timeout-minutes: 90

    env:
      ADK_INSTALL_PATH: C:\ADK
      WORKDIR: C:\winpe_work
      OUTDIR: C:\out
      # Microsoft Learn page currently points these linkids for ADK 10.1.26100.2454 (Dec 2024).
      # If Microsoft updates linkids in the future, update here.
      ADK_SETUP_URL: "https://go.microsoft.com/fwlink/?linkid=2289980"
      WINPE_ADDON_URL: "https://go.microsoft.com/fwlink/?linkid=2289981"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare folders
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "${env:WORKDIR}" | Out-Null
          New-Item -ItemType Directory -Force -Path "${env:OUTDIR}" | Out-Null
          New-Item -ItemType Directory -Force -Path "$env:RUNNER_TEMP\adk" | Out-Null

      - name: Download ADK + WinPE Add-on installers
        shell: pwsh
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "${env:ADK_SETUP_URL}" -OutFile "$env:RUNNER_TEMP\adk\adksetup.exe"
          Invoke-WebRequest -Uri "${env:WINPE_ADDON_URL}" -OutFile "$env:RUNNER_TEMP\adk\adkwinpesetup.exe"
          Get-ChildItem "$env:RUNNER_TEMP\adk" | Format-Table Name,Length

      - name: Install Windows ADK (Deployment Tools only)
        shell: pwsh
        run: |
          $adk = "$env:RUNNER_TEMP\adk\adksetup.exe"
          $args = @(
            "/quiet",
            "/norestart",
            "/ceip", "off",
            "/installpath", "$env:ADK_INSTALL_PATH",
            "/features", "OptionId.DeploymentTools"
          )
          $p = Start-Process -FilePath $adk -ArgumentList $args -Wait -PassThru
          if ($p.ExitCode -ne 0) { throw "ADK install failed with exit code $($p.ExitCode)" }

      - name: Install WinPE Add-on
        shell: pwsh
        run: |
          $pe = "$env:RUNNER_TEMP\adk\adkwinpesetup.exe"
          $args = @(
            "/quiet",
            "/norestart",
            "/ceip", "off",
            "/installpath", "$env:ADK_INSTALL_PATH",
            "/features", "OptionId.WindowsPreinstallationEnvironment"
          )
          $p = Start-Process -FilePath $pe -ArgumentList $args -Wait -PassThru
          if ($p.ExitCode -ne 0) { throw "WinPE add-on install failed with exit code $($p.ExitCode)" }

      - name: Create WinPE working set (copype)
        shell: pwsh
        run: |
          $arch = "${{ inputs.architecture || 'amd64' }}"
          $work = "$env:WORKDIR\WinPE_$arch"

          # ADK "Deployment and Imaging Tools Environment" sets these tools in PATH.
          # We call the batch file that sets env vars, then run copype.
          $dandit = Join-Path $env:ADK_INSTALL_PATH "Assessment and Deployment Kit\Deployment Tools\DandISetEnv.bat"
          if (!(Test-Path $dandit)) { throw "DandISetEnv.bat not found: $dandit" }

          cmd /c "`"$dandit`" && copype $arch `"$work`""
          if (!(Test-Path "$work\media\sources\boot.wim")) { throw "boot.wim not found after copype" }

      - name: Customize boot.wim (inject startnet.cmd + scripts)
        shell: pwsh
        run: |
          $arch = "${{ inputs.architecture || 'amd64' }}"
          $work = "$env:WORKDIR\WinPE_$arch"
          $wim  = "$work\media\sources\boot.wim"
          $mnt  = "$work\mount"

          New-Item -ItemType Directory -Force -Path $mnt | Out-Null

          # Mount
          dism /Mount-Image /ImageFile:"$wim" /Index:1 /MountDir:"$mnt"

          try {
            # 1) startnet.cmd override
            $srcStartnet = Join-Path $env:GITHUB_WORKSPACE "winpe\startnet.cmd"
            if (!(Test-Path $srcStartnet)) {
              throw "Missing repo file: winpe/startnet.cmd"
            }
            Copy-Item -Force $srcStartnet (Join-Path $mnt "Windows\System32\startnet.cmd")

            # 2) scripts folder
            $srcScripts = Join-Path $env:GITHUB_WORKSPACE "winpe\scripts"
            if (!(Test-Path $srcScripts)) {
              throw "Missing repo folder: winpe/scripts/"
            }
            $dstScripts = Join-Path $mnt "ablestack\scripts"
            New-Item -ItemType Directory -Force -Path $dstScripts | Out-Null
            Copy-Item -Recurse -Force (Join-Path $srcScripts "*") $dstScripts

            # 3) optional: stamp version info
            $stamp = "BuiltBy=GitHubActions`nBuildTimeUtc=$(Get-Date -Format o -AsUTC)"
            $dstMeta = Join-Path $mnt "ablestack\scripts\BUILDINFO.txt"
            $stamp | Out-File -Encoding ascii -Force $dstMeta
          }
          finally {
            # Commit + unmount
            dism /Unmount-Image /MountDir:"$mnt" /Commit
          }

      - name: Build WinPE ISO (MakeWinPEMedia)
        shell: pwsh
        run: |
          $arch = "${{ inputs.architecture || 'amd64' }}"
          $work = "$env:WORKDIR\WinPE_$arch"
          $name = "${{ inputs.iso_name || 'winpe-ablestack-v2k' }}"
          $iso  = Join-Path $env:OUTDIR "$name-$arch.iso"

          $dandit = Join-Path $env:ADK_INSTALL_PATH "Assessment and Deployment Kit\Deployment Tools\DandISetEnv.bat"
          cmd /c "`"$dandit`" && MakeWinPEMedia /ISO `"$work`" `"$iso`""

          if (!(Test-Path $iso)) { throw "ISO not created: $iso" }
          Get-Item $iso | Format-List FullName,Length

      - name: Generate SHA256SUMS
        shell: pwsh
        run: |
          $arch = "${{ inputs.architecture || 'amd64' }}"
          $name = "${{ inputs.iso_name || 'winpe-ablestack-v2k' }}"
          $iso  = Join-Path $env:OUTDIR "$name-$arch.iso"
          $sum  = Join-Path $env:OUTDIR "SHA256SUMS"

          $hash = (Get-FileHash -Algorithm SHA256 $iso).Hash.ToLower()
          $line = "$hash  $(Split-Path -Leaf $iso)"
          $line | Out-File -Encoding ascii -Force $sum

          Get-Content $sum

      - name: Upload artifact (ISO + SHA256SUMS)
        uses: actions/upload-artifact@v4
        with:
          name: winpe-iso
          path: |
            C:\out\*.iso
            C:\out\SHA256SUMS
          retention-days: 14

      # Optional: attach to GitHub Release when workflow triggered by release
      - name: Attach assets to GitHub Release (only on release)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            C:\out\*.iso
            C:\out\SHA256SUMS