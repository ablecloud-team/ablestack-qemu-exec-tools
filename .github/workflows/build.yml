name: Build and Release ablestack-qemu-exec-tools

on:
  push:
    tags:
      - "v*"

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1) RPM BUILD (Rocky 9 + 10 ë³‘í–‰)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-rpm:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os_version: [9, 10]
    container:
      image: rockylinux/rockylinux:${{ matrix.os_version }}
      options: --user 0
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        run: dnf -y install make rpm-build tar git dnf-plugins-core createrepo_c

      - name: Build RPM
        run: make rpm

      - name: Create RPM repo (with dependencies) for Rocky ${{ matrix.os_version }}
        run: |
          set -e
          WORKDIR="repo/rpm-rocky${{ matrix.os_version }}"
          mkdir -p "$WORKDIR"

          # ë³¸ì²´ RPM ë³µì‚¬
          cp rpmbuild/RPMS/*/*.rpm "$WORKDIR"/

          echo "[INFO] Downloading runtime dependencies..."
          # specì˜ Requiresë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì˜ì¡´ì„± ì „ë¶€ ëª¨ì•„ ì €ìž¥
          dnf download --resolve --alldeps \
            --destdir="$WORKDIR" \
            bash jq libvirt-client cloud-init || true

          echo "[INFO] Creating repo metadata..."
          createrepo_c "$WORKDIR"

          # ì•„í‹°íŒ©íŠ¸ ë””ë ‰í† ë¦¬ ì •ë¦¬
          mkdir -p release/rpm
          mv repo release/rpm/

      - uses: actions/upload-artifact@v4
        with:
          name: rpm-package-${{ matrix.os_version }}
          path: release/rpm/**

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2) DEB BUILD (Ubuntu 22.04 / 24.04)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-deb:
    strategy:
      matrix:
        os_version: [22.04, 24.04]
    runs-on: ubuntu-${{ matrix.os_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential make dpkg-dev debhelper git apt-utils

      - name: Build DEB
        run: make deb

      - name: Download dependencies and create APT repo
        run: |
          set -e
          sudo apt-get update -y

          # ISOìš© ë¡œì»¬ APT ë¦¬í¬ ìƒì„± ê³µê°„
          mkdir -p repo/pool
          find build/deb -type f -name "*.deb" -exec cp {} repo/pool/ \;

          cd repo/pool

          echo "[INFO] Starting dependency collection..."
          # ì´ë¯¸ ì²˜ë¦¬í•œ íŒ¨í‚¤ì§€ ì´ë¦„ ê¸°ì–µ
          seen_pkgs=""
          # ìƒˆ .debì´ ì¶”ê°€ë˜ëŠ” ë™ì•ˆ ë°˜ë³µ
          new_pkgs=1
          while [ "$new_pkgs" -eq 1 ]; do
            new_pkgs=0
            for deb in *.deb; do
              [ -e "$deb" ] || continue
              P=$(dpkg-deb -f "$deb" Package)
              if echo "$seen_pkgs" | grep -qw "$P"; then
                continue
              fi
              seen_pkgs="$seen_pkgs $P"

              # Depends íŒŒì‹±: ì½¤ë§ˆ ë¶„ë¦¬, ë²„ì „/ê´„í˜¸ ì œê±°, ëŒ€ì²´(|)ëŠ” ì²« í† í°, :any ì œê±°
              DEPS=$(dpkg-deb -f "$deb" Depends | \
                     tr ',' '\n'          | \
                     sed -E 's/\(.*\)//g' | \
                     sed 's/|/ /g'        | \
                     sed 's/:any//g'      | \
                     awk '{print $1}'     | \
                     grep -v '^$'         | \
                     sort -u)
              echo "[INFO] [$P] depends on: $DEPS"

              for dep in $DEPS; do
                [ -n "$dep" ] || continue
                # ì´ë¯¸ poolì— ê°™ì€ íŒ¨í‚¤ì§€ ë‚´ë ¤ë°›ì€ ê²½ìš°ëŠ” ë„˜ì–´ê°
                if ls -1 ${dep}_*.deb >/dev/null 2>&1; then
                  continue
                fi
                echo "[INFO] Downloading: $dep"
                if apt-get download "$dep"; then
                  new_pkgs=1
                else
                  echo "[WARN] Failed to download: $dep"
                fi
              done
            done
          done

          echo "[INFO] Total pool count: $(ls -1 *.deb | wc -l)"

          cd ../..
          # ì¸ë±ìŠ¤ ìƒì„± (repo ë£¨íŠ¸ì—ì„œ ì‹¤í–‰í•´ì•¼ Filename ê²½ë¡œê°€ pool/ ë¡œ ë§žìŒ)
          mkdir -p repo/dists/stable/main/binary-amd64
          ( cd repo && dpkg-scanpackages pool /dev/null | gzip -9c > dists/stable/main/binary-amd64/Packages.gz )

          # ë°°í¬ìš© ìœ„ì¹˜ë¡œ ì •ë¦¬
          mv repo "deb-ubuntu${{ matrix.os_version }}"
          mkdir -p release/deb
          mv deb-ubuntu${{ matrix.os_version }} release/deb/

      - uses: actions/upload-artifact@v4
        with:
          name: deb-package-${{ matrix.os_version }}
          path: release/deb/**

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3) WINDOWS MSI BUILD
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install WiX v4
        run: dotnet tool install --global wix --version 4.*

      - name: Add dotnet tools to PATH
        shell: pwsh
        run: echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build MSI
        shell: pwsh
        run: make windows

      - uses: actions/upload-artifact@v4
        with:
          name: msi-package
          path: windows/msi/out/*

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4) RELEASE + ISO CREATION (VirtIO í†µí•© í¬í•¨)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    needs: [build-rpm, build-deb, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # dist/ ì•„ëž˜ì— ëª¨ë“  ì•„í‹°íŒ©íŠ¸ ë‚´ë ¤ë°›ê¸°
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Install packaging tools (genisoimage, 7zip)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y genisoimage p7zip-full

      - name: Collect artifacts into structured dirs
        run: |
          set -e
          mkdir -p release/rpm release/deb release/msi

          echo "ðŸ” Collecting RPM repos..."
          for ver in 9 10; do
            SRC_DIR=$(find dist -type d -path "*/rpm-package-${ver}/release/rpm/repo/rpm-rocky${ver}" | head -n 1)
            if [ -d "$SRC_DIR" ]; then
              echo "[INFO] Found $SRC_DIR"
              mkdir -p release/rpm/rpm-rocky${ver}
              cp -r "$SRC_DIR"/* release/rpm/rpm-rocky${ver}/
            else
              SRC_DIR=$(find dist -type d -path "*/rpm-package-${ver}/repo/rpm-rocky${ver}" | head -n 1)
              if [ -d "$SRC_DIR" ]; then
                echo "[INFO] Found (fallback) $SRC_DIR"
                mkdir -p release/rpm/rpm-rocky${ver}
                cp -r "$SRC_DIR"/* release/rpm/rpm-rocky${ver}/
              else
                echo "[WARN] No RPM repo found for version ${ver}"
              fi
            fi
          done

          echo "ðŸ” Collecting DEB repos..."
          for ver in 22.04 24.04; do
            SRC_DIR=$(find dist -type d \( \
                        -path "*/deb-package-${ver}/release/deb/deb-ubuntu${ver}" -o \
                        -path "*/deb-package-${ver}/deb-ubuntu${ver}" \
                      \) | head -n 1)
            if [ -d "$SRC_DIR" ]; then
              echo "[INFO] Found $SRC_DIR"
              mkdir -p release/deb/deb-ubuntu${ver}
              cp -r "$SRC_DIR"/* release/deb/deb-ubuntu${ver}/
            else
              echo "[WARN] No DEB repo found for version ${ver}"
            fi
          done

          echo "ðŸ” Collecting MSI artifacts..."
          find dist -type f -path "*/msi-package/*" -exec cp {} release/msi/ \;

      # VirtIO Windows Stable ISO ë‹¤ìš´ë¡œë“œ ë° ì¶”ì¶œ â†’ release/virtio ì— í¬í•¨
      - name: Download & expand VirtIO Windows ISO (stable)
        run: |
          set -e
          mkdir -p dist/virtio-src release/virtio
          curl -fL -o dist/virtio-win.iso \
            "https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso"
          7z x -y -o"dist/virtio-src" dist/virtio-win.iso
          cp -rv dist/virtio-src/* release/virtio/ || true

      # Windows ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ë£¨íŠ¸: install.ps1/install.bat)
      - name: Create Windows installer scripts
        shell: bash
        run: |
          cat > release/install.ps1 << 'PS1'
          Param(
            [switch]$Silent
          )

          function Ensure-Admin {
            $id = [Security.Principal.WindowsIdentity]::GetCurrent()
            $p  = New-Object Security.Principal.WindowsPrincipal($id)
            if (-not $p.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
              Write-Host "[INFO] Elevation required. Re-launching as Administrator..."
              $psi = New-Object System.Diagnostics.ProcessStartInfo
              $psi.FileName  = "powershell.exe"
              $psi.Arguments = "-NoProfile -ExecutionPolicy Bypass -File `"$($MyInvocation.MyCommand.Path)`" " + ($args -join ' ')
              $psi.Verb = "runas"
              [Diagnostics.Process]::Start($psi) | Out-Null
              exit
            }
          }

          # GUI message support
          $Global:GuiReady = $false
          try {
            Add-Type -AssemblyName PresentationFramework -ErrorAction Stop
            $Global:GuiReady = $true
          } catch {
            $Global:GuiReady = $false
          }

          function Show-Info([string]$text) {
            if ($Global:GuiReady -and -not $Silent) {
              [System.Windows.MessageBox]::Show($text, "ABLESTACK Installer",
                [System.Windows.MessageBoxButton]::OK,
                [System.Windows.MessageBoxImage]::Information,
                [System.Windows.MessageBoxResult]::OK,
                [System.Windows.MessageBoxOptions]::DefaultDesktopOnly
              ) | Out-Null
            } else {
              Write-Host $text
            }
          }

          function Prompt-Reboot() {
            if (-not $Global:GuiReady -or $Silent) {
              Write-Host "[NOTICE] A reboot is required to complete installation."
              return
            }
            $msg = "Installation is complete. Some components require a system reboot to finish setup.`r`nDo you want to reboot now?"
            $result = [System.Windows.MessageBox]::Show($msg, "ABLESTACK Installer",
              [System.Windows.MessageBoxButton]::YesNo,
              [System.Windows.MessageBoxImage]::Question,
              [System.Windows.MessageBoxResult]::Yes,
              [System.Windows.MessageBoxOptions]::DefaultDesktopOnly
            )
            if ($result -eq [System.Windows.MessageBoxResult]::Yes) {
              Start-Process "shutdown.exe" -ArgumentList "/r","/t","0"
            }
          }

          Ensure-Admin

          $logPath = "C:\Windows\Temp\ablestack-virtio-install.log"
          Start-Transcript -Path $logPath -Append | Out-Null

          $global:rebootNeeded = $false
          function Handle-MsiExit($code, $component, $logFile) {
            switch ($code) {
              0     { Write-Host "[OK] $component installed."; return }
              3010  { Write-Host "[OK] $component installed. Reboot required (3010)."
                      $global:rebootNeeded = $true; return }
              default { throw "$component install failed with code $code. See $logFile" }
            }
          }

          try {
            $ScriptDir = Split-Path -Path $MyInvocation.MyCommand.Path -Parent
            $VirtioDir = Join-Path $ScriptDir "virtio"
            $MsiDir    = Join-Path $ScriptDir "msi"

            if (-not (Test-Path $MsiDir)) { throw "MSI folder not found: $MsiDir" }

            # Locate VirtIO guest tools EXE
            $candidateExe = @(
              (Join-Path $ScriptDir  "virtio-win-guest-tools.exe"),
              (Join-Path $VirtioDir  "virtio-win-guest-tools.exe")
            ) + (Get-ChildItem -Path $VirtioDir -Recurse -Filter "virtio-win-guest-tools.exe" -ErrorAction SilentlyContinue | Select-Object -Expand FullName)
            $virtioExe = $candidateExe | Where-Object { Test-Path $_ } | Select-Object -First 1

            # MSI fallback
            $candidateMsi = @(
              (Join-Path $ScriptDir "virtio-win-gt-x64.msi"),
              (Join-Path $VirtioDir "virtio-win-gt-x64.msi")
            ) + (Get-ChildItem -Path $VirtioDir -Recurse -Filter "virtio-win-gt-*.msi" -ErrorAction SilentlyContinue | Select-Object -Expand FullName)
            $virtioMsi = $candidateMsi | Where-Object { Test-Path $_ } | Sort-Object -Descending | Select-Object -First 1

            $installOk = $false
            if ($virtioExe) {
              Write-Host "[STEP] Installing VirtIO guest tools (EXE): $virtioExe"
              $exeTry = @('/quiet /norestart','/qn /norestart','/S','/s')
              foreach ($argsStr in $exeTry) {
                Write-Host "  -> Trying args: $argsStr"
                $p = Start-Process -FilePath $virtioExe -ArgumentList $argsStr -PassThru -Wait -NoNewWindow
                if ($p.ExitCode -eq 0 -or $p.ExitCode -eq 3010) {
                  if ($p.ExitCode -eq 3010) { $global:rebootNeeded = $true }
                  $installOk = $true
                  Write-Host "[OK] VirtIO guest tools installed (EXE, code $($p.ExitCode))."
                  break
                } else {
                  Write-Warning "    ExitCode=$($p.ExitCode). Trying next switch..."
                }
              }
            }

            if (-not $installOk) {
              if (-not $virtioMsi) { throw "Neither virtio-win-guest-tools.exe nor virtio-win-gt-*.msi could be executed/found." }
              Write-Host "[STEP] Installing VirtIO guest tools (MSI fallback): $virtioMsi"
              $msiLog = Join-Path $env:TEMP "virtio-win-guest-tools-msi.log"
              $msiArgs = "/i `"$virtioMsi`" /qn /norestart /l*v `"$msiLog`" ADDLOCAL=ALL"
              $p = Start-Process -FilePath "msiexec.exe" -ArgumentList $msiArgs -PassThru -Wait -NoNewWindow
              Handle-MsiExit -code $p.ExitCode -component "VirtIO guest tools (MSI)" -logFile $msiLog
              $installOk = $true
            }

            # Install ablestack MSI
            Write-Host "[STEP] Installing ablestack-qemu-exec-tools (MSI)"
            $execMsi = Get-ChildItem -Path $MsiDir -Filter *.msi | Sort-Object LastWriteTime -Descending | Select-Object -First 1
            if (-not $execMsi) { throw "No ablestack MSI found in $MsiDir" }

            $execLog = Join-Path $env:TEMP "ablestack-qemu-exec-tools-msi.log"
            $execArgs = "/i `"$($execMsi.FullName)`" /qn /norestart /l*v `"$execLog`""
            $p = Start-Process -FilePath "msiexec.exe" -ArgumentList $execArgs -PassThru -Wait -NoNewWindow
            Handle-MsiExit -code $p.ExitCode -component "ablestack-qemu-exec-tools" -logFile $execLog

            # Completion message
            if ($global:rebootNeeded) {
              Prompt-Reboot
            } else {
              Show-Info "Installation completed successfully. No reboot is required."
            }
          }
          catch {
            Write-Error $_
            exit 1
          }
          finally {
            Stop-Transcript | Out-Null
          }
          PS1

          cat > release/install.bat << 'BAT'
          @echo off
          setlocal
          powershell -NoProfile -ExecutionPolicy Bypass -File "%~dp0install.ps1" %*
          if errorlevel 1 (
            echo [ERROR] Install failed. See C:\Windows\Temp\ablestack-virtio-install.log
            exit /b 1
          )
          echo [OK] Installation finished.
          endlocal
          BAT

      - name: Create README.txt (updated)
        run: |
          cat <<'EOF' > release/README.txt
          ablestack-qemu-exec-tools Offline Installation ISO
          ==================================================
          Contents
            - RPM repos:
                rpm/rpm-rocky9
                rpm/rpm-rocky10
            - DEB repos:
                deb/deb-ubuntu22.04
                deb/deb-ubuntu24.04
            - Windows:
                msi/ (ablestack-qemu-exec-tools .msi)
                virtio/ (VirtIO Windows drivers + Guest Tools from stable-virtio)
            - Universal installer:
                install-linux.sh
            - Windows installers:
                install.bat / install.ps1

          Windows (recommended)
            1) Mount ISO in the Windows VM.
            2) Run install.bat (or install.ps1) as Administrator.
               - Installs VirtIO Guest Tools (drivers & agent) silently.
               - Installs ablestack-qemu-exec-tools (MSI) silently.
            3) Reboot is recommended after completion.

          Linux
            1) mount -o loop ablestack-qemu-exec-tools-<VERSION>.iso /mnt
            2) cd /mnt && sudo ./install-linux.sh
          EOF

      - name: Create install-linux.sh (unchanged)
        run: |
          cat <<'EOF' > release/install-linux.sh
          #!/usr/bin/env bash
          set -e
          ISO_MNT=$(dirname "$0")

          echo "[INFO] ABLESTACK QEMU Exec Tools Installer"
          echo "[INFO] Detecting distribution..."

          if [ -f /etc/os-release ]; then
              . /etc/os-release
              DISTRO=$ID
              MAJOR_VERSION=$(echo $VERSION_ID | cut -d'.' -f1)
          else
              echo "[ERROR] Cannot detect distribution!"
              exit 1
          fi

          case "$DISTRO" in
              rocky|rhel|centos|almalinux|fedora)
                  echo "[INFO] Detected RPM-based system ($DISTRO $MAJOR_VERSION)"
                  REPO_FILE=/etc/yum.repos.d/ablestack-qemu-exec-tools.repo
                  REPO_PATH=$(realpath "$ISO_MNT/rpm/rpm-rocky$MAJOR_VERSION")
                  cat <<EOR | sudo tee $REPO_FILE >/dev/null
          [ablestack-qemu-exec-tools]
          name=ablestack-qemu-exec-tools
          baseurl=file://$REPO_PATH
          enabled=1
          gpgcheck=0
          EOR
                  sudo dnf clean all
                  sudo dnf -y --disablerepo="*" --enablerepo="ablestack-qemu-exec-tools" install ablestack-qemu-exec-tools
                  ;;
              ubuntu|debian)
                  echo "[INFO] Detected DEB-based system ($DISTRO $MAJOR_VERSION)"
                  UBUNTU_DIR="${MAJOR_VERSION}.04"
                  REPO_PATH=$(realpath "$ISO_MNT/deb/deb-ubuntu${UBUNTU_DIR}")
                  LIST_FILE=/etc/apt/sources.list.d/ablestack-qemu-exec-tools.list
                  echo "deb [trusted=yes] file://$REPO_PATH stable main" | sudo tee $LIST_FILE >/dev/null
                  sudo apt-get update
                  sudo apt-get -y install ablestack-qemu-exec-tools
                  ;;
              *)
                  echo "[ERROR] Unsupported distribution: $DISTRO"
                  exit 1
                  ;;
          esac

          echo "[INFO] Installation complete."
          EOF
          chmod +x release/install-linux.sh

      - name: Generate ISO
        run: |
          VERSION=${GITHUB_REF##*/}
          mkisofs -o ablestack-qemu-exec-tools-${VERSION}.iso \
            -V "ablestack-qemu-exec-tools ${VERSION}" \
            -r -J release
          mkdir -p build/iso
          mv ablestack-qemu-exec-tools-${VERSION}.iso build/iso/
          ls -lh build/iso

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: "Auto-built offline ISO for RPM (Rocky/RHEL 9,10), DEB (Ubuntu 22.04/24.04) and Windows (VirtIO Guest Tools + ablestack MSI)."
          files: build/iso/*.iso
