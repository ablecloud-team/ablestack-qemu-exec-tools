name: Build and Release ablestack-qemu-exec-tools

on:
  push:
    tags:
      - "v*"

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # 1) RPM BUILD (Rocky 9 + 10 Î≥ëÌñâ)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build-rpm:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os_version: [9, 10]
    container:
      image: rockylinux/rockylinux:${{ matrix.os_version }}
      options: --user 0
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        run: |
          set -e
          # üîß Rocky 10.1 Ïù¥ÌõÑ rpm-sequoia + OpenSSL Ï°∞Ìï©Ïù¥ Î∞îÎÄåÎ©¥ÏÑú
          # Ïª®ÌÖåÏù¥ÎÑà Î≤†Ïù¥Ïä§ Î†àÏù¥Ïñ¥ÏôÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ Î≤ÑÏ†ÑÏù¥ Ïñ¥Í∏ãÎÇòÎäî Í≤ΩÏö∞Í∞Ä ÏûàÏñ¥
          # ‚Üí Î®ºÏ†Ä distro-sync Î°ú rpm / openssl Í≥ÑÏó¥ÏùÑ Î¶¨Ìè¨ ÏÉÅÌÉúÏôÄ ÎßûÏ∂òÎã§.
          dnf -y distro-sync

          # ÎπåÎìúÏóê ÌïÑÏöîÌïú ÎèÑÍµ¨ ÏÑ§Ïπò
          dnf -y install make rpm-build tar git dnf-plugins-core createrepo_c

      - name: Build RPM
        run: make rpm

      - name: Create RPM repo (with dependencies) for Rocky ${{ matrix.os_version }}
        run: |
          set -e
          WORKDIR="repo/rpm-rocky${{ matrix.os_version }}"
          mkdir -p "$WORKDIR"

          # Î≥∏Ï≤¥ RPM Î≥µÏÇ¨
          cp rpmbuild/RPMS/*/*.rpm "$WORKDIR"/

          echo "[INFO] Downloading runtime dependencies..."
          # specÏùò RequiresÎ•º Í∏∞Î∞òÏúºÎ°ú ÏùòÏ°¥ÏÑ± Ï†ÑÎ∂Ä Î™®ÏïÑ Ï†ÄÏû•
          dnf download --resolve --alldeps \
            --destdir="$WORKDIR" \
            bash jq libvirt-client cloud-init || true

          echo "[INFO] Creating repo metadata..."
          createrepo_c "$WORKDIR"

          # ÏïÑÌã∞Ìå©Ìä∏ ÎîîÎ†âÌÜ†Î¶¨ Ï†ïÎ¶¨
          mkdir -p release/rpm
          mv repo release/rpm/

      - uses: actions/upload-artifact@v4
        with:
          name: rpm-package-${{ matrix.os_version }}
          path: release/rpm/**

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # 1-B) V2K RPM BUILD (Î≥ÑÎèÑ Í≤ΩÎ°ú, Í∏∞Ï°¥ ÎπåÎìú ÌîÑÎ°úÏÑ∏Ïä§ ÌõºÏÜê Í∏àÏßÄ)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build-v2k-rpm:
    runs-on: ubuntu-latest
    container:
      image: rockylinux/rockylinux:9
      options: --user 0
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps (v2k)
        run: |
          set -euo pipefail

          # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          # Rocky 9.6 vault Í≥†Ï†ï (AirGap ÏàòÏßëÏö©)
          # - Í∏∞Ï°¥ rocky.repoÎäî mirrorlistÎßå ÏûàÍ≥† baseurlÏù¥ ÏóÜÏùÑ Ïàò ÏûàÏùå
          # - releasever=9.6ÎßåÏúºÎ°úÎäî Ìï¥Í≤∞ ÏïàÎê® (baseurlÏù¥ ÏóÜÏñ¥ÏÑú)
          # - Îî∞ÎùºÏÑú 9.6 vault baseurlÏùÑ Í∞ÄÏßÑ repoÎ•º "ÏßÅÏ†ë" ÏÉùÏÑ±
          # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          cat > /etc/yum.repos.d/rocky-vault-9.6.repo <<'EOF'
          [rocky-vault-9.6-baseos]
          name=Rocky Linux 9.6 - BaseOS (vault)
          baseurl=https://dl.rockylinux.org/vault/rocky/9.6/BaseOS/$basearch/os/
          enabled=1
          gpgcheck=0

          [rocky-vault-9.6-appstream]
          name=Rocky Linux 9.6 - AppStream (vault)
          baseurl=https://dl.rockylinux.org/vault/rocky/9.6/AppStream/$basearch/os/
          enabled=1
          gpgcheck=0

          [rocky-vault-9.6-crb]
          name=Rocky Linux 9.6 - CRB (vault)
          baseurl=https://dl.rockylinux.org/vault/rocky/9.6/CRB/$basearch/os/
          enabled=1
          gpgcheck=0
          EOF

          dnf clean all
          dnf -y --disablerepo="*" --enablerepo="rocky-vault-9.6-*" makecache

          # curl Ï∂©Îèå ÌöåÌîº: curl-minimal ‚Üî curl
          # - Ïª®ÌÖåÏù¥ÎÑà Î≤†Ïù¥Ïä§Ïóê curl-minimalÏù¥ ÍπîÎ¶∞ Í≤ΩÏö∞, ÌïÑÏöî Ïãú allowerasingÏúºÎ°ú Ï†ïÎ¶¨
          dnf -y --disablerepo="*" --enablerepo="rocky-vault-9.6-*" install \
            --allowerasing ca-certificates curl-minimal || true

          dnf -y --disablerepo="*" --enablerepo="rocky-vault-9.6-*" install \
            make rpm-build tar git dnf-plugins-core createrepo_c

      - name: Configure Rocky 9.6 vault repos + enable EPEL (build-time only)
        run: |
          set -euo pipefail

          # ‚ùó ÌïµÏã¨: rocky.repoÎ•º "rewrite"ÌïòÏßÄ ÏïäÎäîÎã§.
          # rocky.repoÎäî mirrorlistÎßå ÏûàÍ≥† baseurlÏù¥ ÏóÜÎäî ÏºÄÏù¥Ïä§Í∞Ä ÏûàÏñ¥
          # mirrorlistÎ•º Ï£ºÏÑù Ï≤òÎ¶¨ÌïòÎ©¥ "baseurl ÏóÜÏùå"ÏúºÎ°ú dnfÍ∞Ä Ï¶âÏãú Ïã§Ìå®ÌïúÎã§.
          # Îî∞ÎùºÏÑú 9.6 vault baseurlÏùÑ Í∞ÄÏßÑ repo ÌååÏùºÏùÑ Î≥ÑÎèÑÎ°ú ÏÉùÏÑ±Ìï¥ÏÑú ÏÇ¨Ïö©ÌïúÎã§.

          cat > /etc/yum.repos.d/rocky-vault-9.6.repo <<'EOF'
          [rocky-vault-9.6-baseos]
          name=Rocky Linux 9.6 - BaseOS (vault)
          baseurl=https://dl.rockylinux.org/vault/rocky/9.6/BaseOS/$basearch/os/
          enabled=1
          gpgcheck=0

          [rocky-vault-9.6-appstream]
          name=Rocky Linux 9.6 - AppStream (vault)
          baseurl=https://dl.rockylinux.org/vault/rocky/9.6/AppStream/$basearch/os/
          enabled=1
          gpgcheck=0

          [rocky-vault-9.6-crb]
          name=Rocky Linux 9.6 - CRB (vault)
          baseurl=https://dl.rockylinux.org/vault/rocky/9.6/CRB/$basearch/os/
          enabled=1
          gpgcheck=0
          EOF

          echo "[INFO] Enabled repos (vault 9.6):"
          grep -nE '^\[|^baseurl=' /etc/yum.repos.d/rocky-vault-9.6.repo

          # vault repoÎßåÏúºÎ°ú Ï∫êÏãú ÏÉùÏÑ±
          dnf -y --disablerepo="*" --enablerepo="rocky-vault-9.6-*" makecache

          # EPELÏùÄ build-time only (nbd Îì± ÏàòÏßë Î™©Ï†Å) ‚Üí Ïó¨Í∏∞ÏÑú ÌôúÏÑ±Ìôî Í∞ÄÎä•
          # ‚ùó vault repoÎßå Ïº† ÏÉÅÌÉúÏóêÏÑúÎäî epel-release Ìå®ÌÇ§ÏßÄÎ•º 'dnf install'Î°ú Ï∞æÏùÑ Ïàò ÏóÜÏùå(No match).
          #     ‚Üí EPEL bootstrap rpmÏùÑ URLÎ°ú ÏßÅÏ†ë ÏÑ§ÏπòÌïúÎã§.
          #     (ÎπåÎìú/Î¶¥Î¶¨Ï¶à Îã®Í≥ÑÏóêÏÑúÎßå Ïô∏Î∂Ä Ï†ëÍ∑º ÌóàÏö©ÌïòÍ≥†, Í≤∞Í≥º rpmÏùÄ ISOÏóê Ìè¨Ìï®)
          EPEL_RPM_URL="https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm"
          echo "[INFO] Installing EPEL release RPM: ${EPEL_RPM_URL}"
          curl -fL -o /tmp/epel-release.rpm "${EPEL_RPM_URL}"
          rpm -Uvh --nosignature /tmp/epel-release.rpm

          # EPEL repo id ÏûêÎèô ÌÉêÏßÄ(epel/epel-9/epel-next Îì± ÏºÄÏù¥Ïä§ ÎåÄÏùë)
          EPEL_REPO_ID="$(dnf repolist all 2>/dev/null | awk 'tolower($1) ~ /^epel/ {print $1; exit}')"
          if [[ -z "${EPEL_REPO_ID}" ]]; then
            echo "[ERR] EPEL repo id not found after installing epel-release." >&2
            dnf repolist all || true
            exit 2
          fi
          echo "[INFO] Detected EPEL repo id: ${EPEL_REPO_ID}"
          echo "EPEL_REPO_ID=${EPEL_REPO_ID}" >> "$GITHUB_ENV"

          # vault + epel Ï∫êÏãú ÏÉùÏÑ±(Îî± ÌïÑÏöîÌïú repoÎßå)
          dnf -y --disablerepo="*" --enablerepo="rocky-vault-9.6-*","${EPEL_REPO_ID}" makecache          

      - name: Build V2K RPM (separate path)
        run: |
          set -e
          # NOTE: Í∏∞Ï°¥ make rpm Í≤ΩÎ°úÏôÄ Î∂ÑÎ¶¨Îêú V2K Ï†ÑÏö© ÌÉÄÍ≤üÏùÑ ÏÇ¨Ïö©Ìï¥Ïïº Ìï®
          #       (Ïòà: make v2k-rpm)
          make v2k-rpm

      - name: Create V2K RPM repo (offline) for ABLESTACK (Rocky 9.6)
        run: |
          set -e
          WORKDIR="release/v2k/v2k-rpm-rocky9.6"
          mkdir -p "$WORKDIR"

          # V2K Î≥∏Ï≤¥ RPM ÏàòÏßë (ÌîÑÎ°úÏ†ùÌä∏ ÏÇ∞Ï∂ú Í≤ΩÎ°úÏóê ÎßûÏ∂∞ ÌïÑÏöî Ïãú Ï°∞Ï†ï)
          find . -type f -name "*.rpm" \( -iname "*ablestack*v2k*.rpm" -o -iname "*ablestack-v2k*.rpm" \) -exec cp -v {} "$WORKDIR"/ \;

          echo "[INFO] Collecting runtime deps for Air-Gap (Requires closure minus ABLESTACK baseline)..."

          # --- 9.6 Í≥†Ï†ï (Ï§ëÏöî: 9.7 ÌòºÏûÖ Ï∞®Îã®) ---
          : "${EPEL_REPO_ID:?EPEL_REPO_ID is not set. Configure step must export it to GITHUB_ENV}"
          # ÏòµÏÖò Î¨∏ÏûêÏó¥Ïóê Îî∞Ïò¥ÌëúÎ•º ÎÑ£ÏßÄ ÎßêÍ≥†, Î∞∞Ïó¥Î°ú Ï†ÑÎã¨(ÌååÏã± ÏïàÏ†ïÏÑ±)
          DNF_COMMON_OPTS=(
            --releasever=9.6
            --disablerepo=*
            --enablerepo="rocky-vault-9.6-*","${EPEL_REPO_ID}"
            --setopt=install_weak_deps=False
          )

          # ablestack-v2k.specÏùò RequiresÏôÄ ÎèôÏùºÌïòÍ≤å Ïú†ÏßÄ (8Í∞ú)
          # ceph-common: rbd CLI ÏÇ¨Ïö©(ÏÉùÏÑ±/Ï°¥Ïû¨ÌôïÏù∏) Î™©Ï†Å
          REQ_PKGS="jq python3 openssl nbd nbdkit nbdkit-vddk-plugin qemu-img libvirt-client"

          # baseline ÌååÏùº(ABLestack 9.6 Ìò∏Ïä§Ìä∏ÏóêÏÑú rpm -qa Í∏∞Î∞òÏúºÎ°ú ÏÉùÏÑ±Ìï¥ Ïª§Î∞ã)
          BASELINE_FILE="rpm/v2k_baseline_pkgs_ablestack_9.6.txt"
          if [[ ! -f "${BASELINE_FILE}" ]]; then
            echo "[ERR] Missing baseline file: ${BASELINE_FILE}" >&2
            echo "      Generate on ABLESTACK 9.6 host:" >&2
            echo "        rpm -qa --qf '%{NAME}\\n' | sort -u > ${BASELINE_FILE}" >&2
            exit 2
          fi

          echo "[INFO] Sanity check: required pkgs availability (repo view)"
          # nbd/nbdkit/qemu-imgÍ∞Ä repoÏóêÏÑú Ïïà Î≥¥Ïù¥Î©¥ Ïó¨Í∏∞ÏÑú Ï¶âÏãú Ïã§Ìå®Ìï¥Ïïº Ìï®(ÏßÄÍ∏à Î¨∏Ï†ú Ï°∞Í∏∞ Ï∞®Îã®)
          dnf -q "${DNF_COMMON_OPTS[@]}" repoquery --available ${REQ_PKGS} >/dev/null

          # Requires ÏùòÏ°¥ÏÑ± ÌÅ¥Î°úÏ†Ä ÏÇ∞Ï∂ú (Ìå®ÌÇ§ÏßÄÎ™ÖÎßå, Ï§ëÎ≥µ Ï†úÍ±∞)
          # dnf-plugins-coreÏùò repoquery ÏÇ¨Ïö©
          dnf -y "${DNF_COMMON_OPTS[@]}" install dnf-plugins-core >/dev/null
          dnf -q "${DNF_COMMON_OPTS[@]}" repoquery \
            --requires --resolve --recursive \
            --qf '%{name}' \
            ${REQ_PKGS} | sort -u > /tmp/v2k_dep_closure.txt

          # (Ï§ëÏöî) Direct requiresÎäî baseline subtractÏôÄ Î¨¥Í¥ÄÌïòÍ≤å Î∞òÎìúÏãú Ìè¨Ìï®
          printf '%s\n' ${REQ_PKGS} | sort -u > /tmp/v2k_must_have.txt


          # baselineÏóê Ïù¥ÎØ∏ ÏûàÎäî Ìå®ÌÇ§ÏßÄ Ï†úÏô∏ (ÏóÜÎäî Í≤ÉÎßå Îã§Ïö¥Î°úÎìú)
          sort -u "${BASELINE_FILE}" > /tmp/v2k_baseline.txt
          comm -23 /tmp/v2k_dep_closure.txt /tmp/v2k_baseline.txt > /tmp/v2k_to_download_closure.txt

          # (Ï§ëÏöî) Direct requiresÎäî baseline subtractÏôÄ Î¨¥Í¥ÄÌïòÍ≤å Î∞òÎìúÏãú Ìè¨Ìï®
          printf '%s\n' ${REQ_PKGS} | sort -u > /tmp/v2k_must_have.txt

          # baseline subtract (closure - baseline)
          sort -u "${BASELINE_FILE}" > /tmp/v2k_baseline.txt
          comm -23 /tmp/v2k_dep_closure.txt /tmp/v2k_baseline.txt > /tmp/v2k_to_download_closure.txt

          # must-have + (closure-baseline) = candidate list
          cat /tmp/v2k_must_have.txt /tmp/v2k_to_download_closure.txt | sort -u > /tmp/v2k_to_download_candidate.txt

          echo "[INFO] Candidate(to-download) count: $(wc -l < /tmp/v2k_to_download_candidate.txt)"
          echo "[INFO] Candidate sample (first 50):"
          head -n 50 /tmp/v2k_to_download_candidate.txt || true

          echo "[INFO] Filtering candidate list by repo availability (STRICT)..."
          # ‚ö†Ô∏è Ï†àÎåÄ $(cat ...) Ïì∞ÏßÄ Îßê Í≤É. Ïù∏Ïûê Í∏∏Ïù¥/ÏóêÎü¨/ÎπàÍ∞íÏúºÎ°ú repo Ï†ÑÏ≤¥Í∞Ä ÎÇòÏò§Îäî ÏÇ¨Í≥†Í∞Ä ÎÇúÎã§.
          # xargsÎ°ú "Ïã§Ï†ú repoÏóê Ï°¥Ïû¨ÌïòÎäî Ìå®ÌÇ§ÏßÄÎ™Ö"Îßå ÎÇ®Í∏¥Îã§.
          : > /tmp/v2k_to_download_avail.txt
          cat /tmp/v2k_to_download_candidate.txt \
            | xargs -r -n 200 dnf -q "${DNF_COMMON_OPTS[@]}" repoquery --available --qf '%{name}' \
            | sort -u > /tmp/v2k_to_download_avail.txt

          # langpack Ìè≠Î∞ú Î∞©ÏßÄ(ÏÑ†Ï†ú Ï†úÍ±∞) - ÌïÑÏöî ÏóÜÏúºÎ©¥ Í≥ºÍ∞êÌûà Ï†úÏô∏
          grep -vE '^glibc-all-langpacks$|^glibc-langpack-' /tmp/v2k_to_download_avail.txt \
            | sort -u > /tmp/v2k_to_download.txt

          # missing(ÌõÑÎ≥¥Ïóî ÏûàÏóàÎäîÎç∞ repoÏóî ÏóÜÎäî Í≤É) Î°úÍπÖ
          comm -23 /tmp/v2k_to_download_candidate.txt /tmp/v2k_to_download_avail.txt > /tmp/v2k_missing_in_repo.txt
          if [[ -s /tmp/v2k_missing_in_repo.txt ]]; then
            echo "[WARN] Missing in enabled repos (skipped):"
            head -n 50 /tmp/v2k_missing_in_repo.txt || true
          fi

          echo "[INFO] Final to-download count(after avail+langpack filter): $(wc -l < /tmp/v2k_to_download.txt)"
          echo "[INFO] Final to-download sample (first 50):"
          head -n 50 /tmp/v2k_to_download.txt || true

          # ÏµúÏ¢Ö Î∞©Ïñ¥: nbd/nbdkit/qemu-imgÎäî Î∞òÎìúÏãú ÏûàÏñ¥Ïïº ÌïúÎã§
          for p in nbd nbdkit qemu-img; do
            if ! grep -qx "$p" /tmp/v2k_to_download.txt && ! grep -qx "$p" /tmp/v2k_baseline.txt; then
              echo "[ERR] Required package '$p' is neither in baseline nor in final download list." >&2
              exit 2
            fi
          done

          # download (Ïó¨Í∏∞ÏÑúÎäî excludeÎ•º Í±∏Ïñ¥ÎèÑ ÎêòÏßÄÎßå, ÏúÑÏóêÏÑú Ïù¥ÎØ∏ Ï†úÍ±∞ÌñàÏúºÎãà ÏóÜÏñ¥ÎèÑ Îê®)
          if [[ -s /tmp/v2k_to_download.txt ]]; then
            xargs -r dnf "${DNF_COMMON_OPTS[@]}" download --destdir="$WORKDIR" < /tmp/v2k_to_download.txt
          else
            echo "[INFO] Nothing to download (all deps satisfied by baseline)."
          fi

          echo "[INFO] Creating repo metadata (createrepo_c)..."
          createrepo_c "$WORKDIR"

          echo "[INFO] Repo metadata sanity check:"
          test -f "$WORKDIR/repodata/repomd.xml"
          ls -al "$WORKDIR/repodata" | head -n 50 || true

      - uses: actions/upload-artifact@v4
        with:
          name: v2k-rpm-package
          path: release/v2k/**

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # 2) DEB BUILD (Ubuntu 22.04 / 24.04)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build-deb:
    strategy:
      matrix:
        os_version: [22.04, 24.04]
    runs-on: ubuntu-${{ matrix.os_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential make dpkg-dev debhelper git apt-utils

      - name: Build DEB
        run: make deb

      - name: Download dependencies and create APT repo
        run: |
          set -e
          sudo apt-get update -y

          # ISOÏö© Î°úÏª¨ APT Î¶¨Ìè¨ ÏÉùÏÑ± Í≥µÍ∞Ñ
          mkdir -p repo/pool
          find build/deb -type f -name "*.deb" -exec cp {} repo/pool/ \;

          cd repo/pool

          echo "[INFO] Starting dependency collection..."
          # Ïù¥ÎØ∏ Ï≤òÎ¶¨Ìïú Ìå®ÌÇ§ÏßÄ Ïù¥Î¶Ñ Í∏∞Ïñµ
          seen_pkgs=""
          # ÏÉà .debÏù¥ Ï∂îÍ∞ÄÎêòÎäî ÎèôÏïà Î∞òÎ≥µ
          new_pkgs=1
          while [ "$new_pkgs" -eq 1 ]; do
            new_pkgs=0
            for deb in *.deb; do
              [ -e "$deb" ] || continue
              P=$(dpkg-deb -f "$deb" Package)
              if echo "$seen_pkgs" | grep -qw "$P"; then
                continue
              fi
              seen_pkgs="$seen_pkgs $P"

              # Depends ÌååÏã±: ÏΩ§Îßà Î∂ÑÎ¶¨, Î≤ÑÏ†Ñ/Í¥ÑÌò∏ Ï†úÍ±∞, ÎåÄÏ≤¥(|)Îäî Ï≤´ ÌÜ†ÌÅ∞, :any Ï†úÍ±∞
              DEPS=$(dpkg-deb -f "$deb" Depends | \
                     tr ',' '\n'          | \
                     sed -E 's/\(.*\)//g' | \
                     sed 's/|/ /g'        | \
                     sed 's/:any//g'      | \
                     awk '{print $1}'     | \
                     grep -v '^$'         | \
                     sort -u)
              echo "[INFO] [$P] depends on: $DEPS"

              for dep in $DEPS; do
                [ -n "$dep" ] || continue
                # Ïù¥ÎØ∏ poolÏóê Í∞ôÏùÄ Ìå®ÌÇ§ÏßÄ ÎÇ¥Î†§Î∞õÏùÄ Í≤ΩÏö∞Îäî ÎÑòÏñ¥Í∞ê
                if ls -1 ${dep}_*.deb >/dev/null 2>&1; then
                  continue
                fi
                echo "[INFO] Downloading: $dep"
                if apt-get download "$dep"; then
                  new_pkgs=1
                else
                  echo "[WARN] Failed to download: $dep"
                fi
              done
            done
          done

          echo "[INFO] Total pool count: $(ls -1 *.deb | wc -l)"

          cd ../..
          # Ïù∏Îç±Ïä§ ÏÉùÏÑ± (repo Î£®Ìä∏ÏóêÏÑú Ïã§ÌñâÌï¥Ïïº Filename Í≤ΩÎ°úÍ∞Ä pool/ Î°ú ÎßûÏùå)
          mkdir -p repo/dists/stable/main/binary-amd64
          ( cd repo && dpkg-scanpackages pool /dev/null | gzip -9c > dists/stable/main/binary-amd64/Packages.gz )

          # Î∞∞Ìè¨Ïö© ÏúÑÏπòÎ°ú Ï†ïÎ¶¨
          mv repo "deb-ubuntu${{ matrix.os_version }}"
          mkdir -p release/deb
          mv deb-ubuntu${{ matrix.os_version }} release/deb/

      - uses: actions/upload-artifact@v4
        with:
          name: deb-package-${{ matrix.os_version }}
          path: release/deb/**

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # 3) WINDOWS MSI BUILD
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install WiX v4
        run: dotnet tool install --global wix --version 4.*

      - name: Add dotnet tools to PATH
        shell: pwsh
        run: echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build MSI
        shell: pwsh
        run: make windows

      - uses: actions/upload-artifact@v4
        with:
          name: msi-package
          path: windows/msi/out/*

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # 4) RELEASE + ISO CREATION (VirtIO ÌÜµÌï© Ìè¨Ìï®)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  release:
    needs: [build-rpm, build-deb, build-windows, build-v2k-rpm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # dist/ ÏïÑÎûòÏóê Î™®Îì† ÏïÑÌã∞Ìå©Ìä∏ ÎÇ¥Î†§Î∞õÍ∏∞
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Install packaging tools (genisoimage, 7zip)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y genisoimage p7zip-full python3-pip

      - name: Collect artifacts into structured dirs
        run: |
          set -e
          mkdir -p release/rpm release/deb release/msi release/assets/v2k/wheels release/v2k

          echo "üîç Collecting RPM repos..."
          for ver in 9 10; do
            SRC_DIR=$(find dist -type d -path "*/rpm-package-${ver}/release/rpm/repo/rpm-rocky${ver}" | head -n 1)
            if [ -d "$SRC_DIR" ]; then
              echo "[INFO] Found $SRC_DIR"
              mkdir -p release/rpm/rpm-rocky${ver}
              cp -r "$SRC_DIR"/* release/rpm/rpm-rocky${ver}/
            else
              SRC_DIR=$(find dist -type d -path "*/rpm-package-${ver}/repo/rpm-rocky${ver}" | head -n 1)
              if [ -d "$SRC_DIR" ]; then
                echo "[INFO] Found (fallback) $SRC_DIR"
                mkdir -p release/rpm/rpm-rocky${ver}
                cp -r "$SRC_DIR"/* release/rpm/rpm-rocky${ver}/
              else
                echo "[WARN] No RPM repo found for version ${ver}"
              fi
            fi
          done

          echo "üîç Collecting DEB repos..."
          for ver in 22.04 24.04; do
            SRC_DIR=$(find dist -type d \( \
                        -path "*/deb-package-${ver}/release/deb/deb-ubuntu${ver}" -o \
                        -path "*/deb-package-${ver}/deb-ubuntu${ver}" \
                      \) | head -n 1)
            if [ -d "$SRC_DIR" ]; then
              echo "[INFO] Found $SRC_DIR"
              mkdir -p release/deb/deb-ubuntu${ver}
              cp -r "$SRC_DIR"/* release/deb/deb-ubuntu${ver}/
            else
              echo "[WARN] No DEB repo found for version ${ver}"
            fi
          done

          echo "üîç Collecting MSI artifacts..."
          find dist -type f -path "*/msi-package/*" -exec cp {} release/msi/ \;

      - name: Collect V2K RPM repo (Rocky 9.6) into ISO tree
        shell: bash
        run: |
          set -euo pipefail
          # build-v2k-rpm outputs: release/v2k/v2k-rpm-rocky9.6
          SRC_DIR=$(find dist -type d -path "*/v2k-rpm-package/v2k-rpm-rocky9.6" -o -path "*/v2k-rpm-package/release/v2k/v2k-rpm-rocky9.6" | head -n 1 || true)
          if [[ -z "${SRC_DIR}" || ! -d "${SRC_DIR}" ]]; then
            echo "[ERR] No V2K RPM repo found in workflow artifacts." >&2
            echo "[ERR] Debug: listing dist/v2k-rpm-package tree (maxdepth=6)" >&2
            find dist -maxdepth 6 -path "*v2k-rpm-package*" -print >&2 || true
            exit 2
          fi

          echo "[INFO] Found V2K repo: ${SRC_DIR}"
          mkdir -p release/v2k/v2k-rpm-rocky9.6
          # Preserve repodata/ and all rpm files
          cp -a "${SRC_DIR}/." release/v2k/v2k-rpm-rocky9.6/

      - name: Stage V2K assets from repo ./assets into ISO (govc, VDDK)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release/assets
          cp -v assets/govc_Linux_x86_64.tar.gz release/assets/ || true
          cp -v assets/VMware-vix-disklib-*.tar.gz release/assets/ || true

      - name: Prepare pyvmomi offline wheels (Air-Gap)
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip download -d release/assets/v2k/wheels "pyvmomi==8.0.3.0.1"

      # VirtIO Windows Stable ISO Îã§Ïö¥Î°úÎìú ÌõÑ "amd64 ÎìúÎùºÏù¥Î≤Ñ + guest tools(qemu-ga Ìè¨Ìï®)"Îßå Ï∂îÏ∂ú
      # - Ï§ëÏ≤© ISO Í∏àÏßÄ
      # - DISM/WinPEÏóêÏÑú Î∞îÎ°ú INF Í≤ΩÎ°ú ÏßÄÏ†ï Í∞ÄÎä•
      # - Ïö©Îüâ Ï†àÍ∞ê(amd64 only)
      - name: Download & extract VirtIO (amd64-only + guest tools)
        run: |
          set -e
          mkdir -p dist/virtio-src release/virtio
          curl -fL -o dist/virtio-win.iso \
            "https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso"

          # 1) DISMÏö©: ÌïµÏã¨ ÎìúÎùºÏù¥Î≤Ñ ÎîîÎ†âÌÜ†Î¶¨Ïùò amd64Îßå Ï∂îÏ∂ú
          #    (VirtIO ISO Î≤ÑÏ†ÑÏóê Îî∞Îùº w11/2k22/2k19 Îì± ÌïòÏúÑ Ìè¥ÎçîÎ™ÖÏù¥ Îã¨ÎùºÎèÑ, amd64 Í≤ΩÎ°úÎßå ÏÇ¥Î¶¨Î©¥ ÎêúÎã§)
          #    7zÎäî ÏôÄÏùºÎìúÏπ¥Îìú Ìå®ÌÑ¥ÏùÑ ÌóàÏö©ÌïòÎØÄÎ°ú, */amd64/* Ìå®ÌÑ¥ÏúºÎ°ú Ï∂îÏ∂úÌïúÎã§.
          7z x -y -o"dist/virtio-src" dist/virtio-win.iso \
            "viostor/*/amd64/*" \
            "vioscsi/*/amd64/*" \
            "NetKVM/*/amd64/*" \
            "Balloon/*/amd64/*" \
            "qemupciserial/*/amd64/*" \
            "viorng/*/amd64/*" \
            "pvpanic/*/amd64/*" \
            "vioinput/*/amd64/*" \
            "vioser/*/amd64/*" || true

          # 2) Guest tools(qemu-ga Ìè¨Ìï®): exe/msiÎäî Î£®Ìä∏ ÎòêÎäî ÌäπÏ†ï ÏúÑÏπòÏóê ÏûàÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú 'Ï∞æÏïÑÏÑú' Ìè¨Ìï®
          #    - Îëò Îã§ ÏûàÏúºÎ©¥ Îëò Îã§ Ìè¨Ìï®(ÌòÑÏû• ÏÑ†ÌÉù Í∞ÄÎä•)
          7z x -y -o"dist/virtio-src" dist/virtio-win.iso "virtio-win-guest-tools.exe" || true
          7z x -y -o"dist/virtio-src" dist/virtio-win.iso "virtio-win-gt-*.msi" || true

          # 3) release/virtioÎ°ú Î≥µÏÇ¨ (Ï°¥Ïû¨ÌïòÎäî Í≤ÉÎßå)
          for d in viostor vioscsi NetKVM Balloon qemupciserial viorng pvpanic vioinput vioser; do
            if [[ -d "dist/virtio-src/${d}" ]]; then
              mkdir -p "release/virtio/${d}"
              cp -a "dist/virtio-src/${d}/." "release/virtio/${d}/"
            fi
          done
          if [[ -f "dist/virtio-src/virtio-win-guest-tools.exe" ]]; then
            cp -a "dist/virtio-src/virtio-win-guest-tools.exe" "release/virtio/"
          fi
          # MSIÎäî Î≤ÑÏ†ÑÎ≥Ñ ÌååÏùºÎ™ÖÏù¥ Îã¨ÎùºÏßà Ïàò ÏûàÏñ¥ glob Î≥µÏÇ¨
          shopt -s nullglob
          for m in dist/virtio-src/virtio-win-gt-*.msi; do
            cp -a "$m" "release/virtio/"
          done
          shopt -u nullglob

          echo "[INFO] virtio payload size:"
          du -sh release/virtio || true
          echo "[INFO] sample INF files:"
          find release/virtio -type f -name '*.inf' | head -n 30 || true

      # Windows ÏÑ§Ïπò Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉùÏÑ± (Î£®Ìä∏: install.ps1/install.bat)
      - name: Create Windows installer scripts
        shell: bash
        run: |
          cat > release/install.ps1 << 'PS1'
          Param(
            [switch]$Silent
          )

          # Force default = false if not provided
          if (-not $PSBoundParameters.ContainsKey('Silent')) {
            $Silent = $false
          }

          # Debug print
          Write-Host "[DEBUG] Silent mode: $Silent"

          function Ensure-Admin {
            $id = [Security.Principal.WindowsIdentity]::GetCurrent()
            $p  = New-Object Security.Principal.WindowsPrincipal($id)
            if (-not $p.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
              Write-Host "[INFO] Elevation required. Re-launching as Administrator..."
              $psi = New-Object System.Diagnostics.ProcessStartInfo
              $psi.FileName  = "powershell.exe"
              $psi.Arguments = "-NoProfile -ExecutionPolicy Bypass -File `"$($MyInvocation.MyCommand.Path)`" " + ($args -join ' ')
              $psi.Verb = "runas"
              [Diagnostics.Process]::Start($psi) | Out-Null
              exit
            }
          }

          # WinForms GUI setup
          $Global:GuiReady = $false
          try {
            Add-Type -AssemblyName System.Windows.Forms -ErrorAction Stop
            $Global:GuiReady = $true
          } catch {
            $Global:GuiReady = $false 
            Write-Host "[WARN] Cannot load System.Windows.Forms. GUI dialogs will be disabled."
          }

          function Show-Info([string]$text) {
            if ($Global:GuiReady -and -not $Silent) {
              [void][System.Windows.Forms.MessageBox]::Show(
                $text,
                "ABLESTACK Installer",
                [System.Windows.Forms.MessageBoxButtons]::OK,
                [System.Windows.Forms.MessageBoxIcon]::Information
              )
            } else {
              Write-Host $text
            }
          }

          function Prompt_Reboot {
              param(
                  [string]$Message = "ABLESTACK tools installation is complete. The system needs to reboot.",
                  [string]$Title   = "ABLESTACK",
                  [int]   $Options = 0x0,     # 0x0: OK only / 0x4: Yes/No Îì±
                  [int]   $TimeoutSeconds = 60  # ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÏµúÎåÄ ÎåÄÍ∏∞ ÏãúÍ∞Ñ (Ï¥à)
              )

              $shell = New-Object -ComObject WScript.Shell

              # Îëê Î≤àÏß∏ Ïù∏ÏûêÏóê ÌÉÄÏûÑÏïÑÏõÉ(Ï¥à)ÏùÑ ÎÑ£ÎäîÎã§.
              # Î∞òÌôòÍ∞í:
              #   -1 : ÌÉÄÏûÑÏïÑÏõÉ
              #    1 : OK
              #    6 : Yes (0x4 ÏòµÏÖòÏùº Îïå)
              $result = $shell.Popup($Message, $TimeoutSeconds, $Title, $Options)

              if ($result -eq -1 -or $result -eq 1 -or $result -eq 6) {
                  Write-Host "Prompt_Reboot: user accepted or no response within timeout. Rebooting..."
                  # Ïû¨Î∂ÄÌåÖ Î∞îÎ°ú ÏàòÌñâ (ÏõêÎûò Ïä§ÌéôÎåÄÎ°ú)
                  Restart-Computer -Force
                  # MSI CustomActionÏù¥ÎùºÎ©¥ Ïã§Ï†úÎ°úÎäî Ïó¨Í∏∞ÏÑú
                  #   msiexec /i ... /norestart + REBOOT=ReallySuppress
                  # Î•º Ïì∞Í≥† ÏãúÏä§ÌÖú Ïû¨Î∂ÄÌåÖÏùÄ Î≥ÑÎèÑ Í¥ÄÎ¶¨Ïûê Ïä§ÌÅ¨Î¶ΩÌä∏ÏóêÏÑú Ï≤òÎ¶¨ÌïòÎäî ÏãùÎèÑ Í∞ÄÎä•ÌïòÏßÄÎßå,
                  # ÏßÄÍ∏à Íµ¨Ï°∞ÏóêÏÑúÎäî Restart-Computer Ïç®ÎèÑ Îê®.
              }
              else {
                  Write-Host "Prompt_Reboot: user canceled reboot (result = $result)."
              }
          }

          Ensure-Admin

          $logPath = "C:\Windows\Temp\ablestack-virtio-install.log"
          Start-Transcript -Path $logPath -Append | Out-Null

          $global:rebootNeeded = $false
          function Handle-MsiExit($code, $component, $logFile) {
            switch ($code) {
              0     { Write-Host "[OK] $component installed."; return }
              3010  { Write-Host "[OK] $component installed. Reboot required (3010)."
                      $global:rebootNeeded = $true; return }
              default { throw "$component install failed with code $code. See $logFile" }
            }
          }

          try {
            $ScriptDir = Split-Path -Path $MyInvocation.MyCommand.Path -Parent
            $VirtioDir = Join-Path $ScriptDir "virtio"
            $MsiDir    = Join-Path $ScriptDir "msi"

            if (-not (Test-Path $MsiDir)) { throw "MSI folder not found: $MsiDir" }

            # Locate VirtIO guest tools EXE
            $candidateExe = @(
              (Join-Path $ScriptDir  "virtio-win-guest-tools.exe"),
              (Join-Path $VirtioDir  "virtio-win-guest-tools.exe")
            ) + (Get-ChildItem -Path $VirtioDir -Recurse -Filter "virtio-win-guest-tools.exe" -ErrorAction SilentlyContinue | Select-Object -Expand FullName)
            $virtioExe = $candidateExe | Where-Object { Test-Path $_ } | Select-Object -First 1

            # MSI fallback
            $candidateMsi = @(
              (Join-Path $ScriptDir "virtio-win-gt-x64.msi"),
              (Join-Path $VirtioDir "virtio-win-gt-x64.msi")
            ) + (Get-ChildItem -Path $VirtioDir -Recurse -Filter "virtio-win-gt-*.msi" -ErrorAction SilentlyContinue | Select-Object -Expand FullName)
            $virtioMsi = $candidateMsi | Where-Object { Test-Path $_ } | Sort-Object -Descending | Select-Object -First 1

            $installOk = $false
            if ($virtioExe) {
              Write-Host "[STEP] Installing VirtIO guest tools (EXE): $virtioExe"
              $exeTry = @('/quiet /norestart','/qn /norestart','/S','/s')
              foreach ($argsStr in $exeTry) {
                Write-Host "  -> Trying args: $argsStr"
                $p = Start-Process -FilePath $virtioExe -ArgumentList $argsStr -PassThru -Wait -NoNewWindow
                if ($p.ExitCode -eq 0 -or $p.ExitCode -eq 3010) {
                  if ($p.ExitCode -eq 3010) { $global:rebootNeeded = $true }
                  $installOk = $true
                  Write-Host "[OK] VirtIO guest tools installed (EXE, code $($p.ExitCode))."
                  break
                } else {
                  Write-Warning "    ExitCode=$($p.ExitCode). Trying next switch..."
                }
              }
            }

            if (-not $installOk) {
              if (-not $virtioMsi) { throw "Neither virtio-win-guest-tools.exe nor virtio-win-gt-*.msi could be executed/found." }
              Write-Host "[STEP] Installing VirtIO guest tools (MSI fallback): $virtioMsi"
              $msiLog = Join-Path $env:TEMP "virtio-win-guest-tools-msi.log"
              $msiArgs = "/i `"$virtioMsi`" /qn /norestart /l*v `"$msiLog`" ADDLOCAL=ALL"
              $p = Start-Process -FilePath "msiexec.exe" -ArgumentList $msiArgs -PassThru -Wait -NoNewWindow
              Handle-MsiExit -code $p.ExitCode -component "VirtIO guest tools (MSI)" -logFile $msiLog
              $installOk = $true
            }

            # Install ablestack MSI
            Write-Host "[STEP] Installing ablestack-qemu-exec-tools (MSI)"
            $execMsi = Get-ChildItem -Path $MsiDir -Filter *.msi | Sort-Object LastWriteTime -Descending | Select-Object -First 1
            if (-not $execMsi) { throw "No ablestack MSI found in $MsiDir" }

            $execLog = Join-Path $env:TEMP "ablestack-qemu-exec-tools-msi.log"
            $execArgs = "/i `"$($execMsi.FullName)`" /qn /norestart /l*v `"$execLog`""
            $p = Start-Process -FilePath "msiexec.exe" -ArgumentList $execArgs -PassThru -Wait -NoNewWindow
            Handle-MsiExit -code $p.ExitCode -component "ablestack-qemu-exec-tools" -logFile $execLog

            # Completion message
            if ($global:rebootNeeded) {
              Prompt_Reboot "ABLESTACK tools installation completed. Reboot now?" "ABLESTACK" 0x0 30
              # ‚Üí 30Ï¥àÎßå Í∏∞Îã§Î¶∞ Îí§ ÏûêÎèô Ïû¨Î∂ÄÌåÖ
            } else {
              Show-Info "Installation completed successfully. No reboot is required."
            }
          }
          catch {
            Write-Error $_
            exit 1
          }
          finally {
            Stop-Transcript | Out-Null
          }
          PS1

          cat > release/install.bat << 'BAT'
          @echo off
          setlocal
          rem Always run non-silent mode by default
          powershell -NoProfile -ExecutionPolicy Bypass -File "%~dp0install.ps1"
          if errorlevel 1 (
            echo [ERROR] Install failed. See C:\Windows\Temp\ablestack-virtio-install.log
            exit /b 1
          )
          
          REM --- ÏÑ§Ïπò Ï†àÏ∞® ÎÅù ---
          mkdir "C:\ProgramData\AbleStack" 2>nul
          echo ok> "C:\ProgramData\AbleStack\autoinstall.done"
          echo [OK] Installation finished.
          endlocal
          BAT

      - name: Create README.txt (updated)
        run: |
          cat <<'EOF' > release/README.txt
          ablestack-qemu-exec-tools Offline Installation ISO
          ==================================================
          Contents
            - RPM repos:
                rpm/rpm-rocky9
                rpm/rpm-rocky10
            - DEB repos:
                deb/deb-ubuntu22.04
                deb/deb-ubuntu24.04
            - Windows:
                msi/ (ablestack-qemu-exec-tools .msi)
                virtio/ (VirtIO Windows drivers + Guest Tools from stable-virtio)
            - Universal installer:
                install-linux.sh
            - Windows installers:
                install.bat / install.ps1
            - V2K (ABLESTACK Host add-on):
                v2k/v2k-rpm-rocky9.6 (offline RPM repo for ablestack_v2k)
                assets/govc_Linux_x86_64.tar.gz
                assets/VMware-vix-disklib-*.tar.gz
                assets/v2k/wheels (pyvmomi offline wheels)


          Windows (recommended)
            1) Mount ISO in the Windows VM.
            2) Run install.bat (or install.ps1) as Administrator.
               - Installs VirtIO Guest Tools (drivers & agent) silently.
               - Installs ablestack-qemu-exec-tools (MSI) silently.
            3) Reboot is recommended after completion.

          Linux
            1) mount -o loop ablestack-qemu-exec-tools-<VERSION>.iso /mnt
            2) cd /mnt && sudo ./install-linux.sh
          EOF

      - name: Create install-linux.sh (V2K add-on for ABLESTACK; keep existing flows)
        run: |
          cat <<'EOF' > release/install-linux.sh
          #!/usr/bin/env bash
          set -e
          ISO_MNT="$(cd "$(dirname "$0")" && pwd -P)"

          echo "[INFO] ABLESTACK QEMU Exec Tools Installer"
          echo "[INFO] Detecting distribution..."

          if [ -f /etc/os-release ]; then
              . /etc/os-release
              DISTRO=$ID
              MAJOR_VERSION=$(echo $VERSION_ID | cut -d'.' -f1)
          else
              echo "[ERROR] Cannot detect distribution!"
              exit 1
          fi

          case "$DISTRO" in
              rocky|rhel|centos|almalinux|fedora)
                  echo "[INFO] Detected RPM-based system ($DISTRO $MAJOR_VERSION)"
                  REPO_FILE=/etc/yum.repos.d/ablestack-qemu-exec-tools.repo
                  REPO_PATH=$(realpath "$ISO_MNT/rpm/rpm-rocky$MAJOR_VERSION")
                  sudo tee "$REPO_FILE" >/dev/null <<EOR
          [ablestack-qemu-exec-tools]
          name=ablestack-qemu-exec-tools
          baseurl=file://$REPO_PATH
          enabled=1
          gpgcheck=0
          EOR
                  sudo dnf clean all
                  sudo dnf -y --disablerepo="*" --enablerepo="ablestack-qemu-exec-tools" install ablestack-qemu-exec-tools
                  sudo rm -f /etc/yum.repos.d/ablestack-qemu-exec-tools.repo
                  sudo dnf clean all
                  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                  # V2K add-on (ABLESTACK Host only)
                  #  - based on bin/v2k_test_install.sh
                  #  - Air-Gap: pyvmomi installs from ISO offline wheels
                  #  - NO ldconfig / NO global linker path modifications
                  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                  if [[ "${PRETTY_NAME:-}" == *"ABLESTACK"* && "${VERSION_ID:-}" == 9.6* ]]; then
                      echo "[INFO] ABLESTACK 9.6 detected. Installing V2K add-on..."

                      has_cmd() { command -v "$1" >/dev/null 2>&1; }

                      # 1) Install ablestack_v2k RPM from ISO local repo
                      V2K_REPO_DIR="${ISO_MNT}/v2k/v2k-rpm-rocky9.6"
                      if [[ -d "${V2K_REPO_DIR}" ]]; then
                          V2K_REPO_FILE=/etc/yum.repos.d/ablestack-v2k.repo
                          sudo tee "${V2K_REPO_FILE}" >/dev/null <<-EOV
          [ablestack-v2k]
          name=ablestack-v2k
          baseurl=file://${V2K_REPO_DIR}
          enabled=1
          gpgcheck=0
          EOV
                          sudo dnf clean all
                          sudo dnf -y --disablerepo="*" --enablerepo="ablestack-v2k" install ablestack-v2k || \
                            sudo dnf -y --disablerepo="*" --enablerepo="ablestack-v2k" install ablestack_v2k || \
                            sudo dnf -y localinstall "${V2K_REPO_DIR}"/*.rpm
                          sudo rm -f "${V2K_REPO_FILE}"
                          sudo dnf clean all
                      else
                          echo "[WARN] V2K RPM repo not found in ISO: ${V2K_REPO_DIR}"
                      fi

                      # 2) govc from ISO assets
                      GOVC_TGZ="${ISO_MNT}/assets/govc_Linux_x86_64.tar.gz"
                      if [[ -f "${GOVC_TGZ}" ]]; then
                          echo "[INFO] Installing govc from asset: ${GOVC_TGZ}"
                          tmp="$(mktemp -d)"
                          tar -xzf "${GOVC_TGZ}" -C "${tmp}"
                          bin="${tmp}/govc"
                          if [[ ! -f "${bin}" ]]; then
                              bin="$(find "${tmp}" -maxdepth 3 -type f -name govc | head -n1 || true)"
                          fi
                          if [[ -f "${bin}" ]]; then
                              sudo install -m 0755 "${bin}" /usr/local/bin/govc
                              echo "[OK] govc installed to /usr/local/bin/govc"
                          else
                              echo "[WARN] govc binary not found inside ${GOVC_TGZ}"
                          fi
                          rm -rf "${tmp}"
                      else
                          echo "[WARN] govc asset not found: ${GOVC_TGZ}"
                      fi

                      # 3) VMware VDDK from ISO assets (NO ldconfig)
                      VDDK_TGZ="$(ls -1 "${ISO_MNT}"/assets/VMware-vix-disklib-*.tar.gz 2>/dev/null | sort | tail -n1 || true)"
                      if [[ -n "${VDDK_TGZ}" ]]; then
                          echo "[INFO] Installing VMware VDDK from asset: ${VDDK_TGZ}"
                          sudo mkdir -p /opt
                          tmp="$(mktemp -d)"
                          tar -xzf "${VDDK_TGZ}" -C "${tmp}"
                          distrib="$(find "${tmp}" -maxdepth 2 -type d \( -iname 'vmware-vix-disklib-distrib' -o -iname 'VMware-vix-disklib-distrib' \) | head -n1 || true)"
                          if [[ -z "${distrib}" ]]; then
                              distrib="$(find "${tmp}" -maxdepth 2 -type d -iname '*disklib*distrib*' | head -n1 || true)"
                          fi
                          if [[ -n "${distrib}" && -d "${distrib}" ]]; then
                              base_name="$(basename "${VDDK_TGZ}" .tar.gz)"
                              base_name="${base_name// /_}"
                              dest_versioned="/opt/${base_name}"
                              sudo rm -rf "${dest_versioned}" >/dev/null 2>&1 || true
                              sudo cp -a "${distrib}" "${dest_versioned}"
                              sudo ln -sfn "${dest_versioned}" /opt/vmware-vix-disklib-distrib
                              echo "[OK] VDDK installed to ${dest_versioned} (symlink: /opt/vmware-vix-disklib-distrib)"
                              echo "[INFO] NOTE: ablestack_v2k should pass VDDK libdir to nbdkit at runtime."

                              # write_profiled_env() from v2k_test_install.sh
                              # - DO NOT run ldconfig / DO NOT touch global linker paths
                              # - Just export default VDDK_LIBDIR for ablestack_v2k runtime
                              VDDK_LIBDIR="/opt/vmware-vix-disklib-distrib"
                              PROFILED_FILE="/etc/profile.d/v2k-vddk.sh"
                              sudo tee "${PROFILED_FILE}" >/dev/null <<EOP
          # Generated by install-linux.sh (V2K add-on)
          export VDDK_LIBDIR="${VDDK_LIBDIR}"
          EOP
                              sudo chmod 0644 "${PROFILED_FILE}"
                              # best-effort source for current session (non-fatal)
                              # shellcheck disable=SC1090
                              source "${PROFILED_FILE}" || true
                              echo "[OK] Wrote VDDK_LIBDIR default to ${PROFILED_FILE}"
                          else
                              echo "[WARN] Could not locate VDDK distrib directory in ${VDDK_TGZ}"
                          fi
                          rm -rf "${tmp}"
                      else
                          echo "[WARN] VDDK asset not found: ${ISO_MNT}/assets/VMware-vix-disklib-*.tar.gz"
                      fi

                      # 4) pyvmomi (offline wheels)
                      WHEEL_DIR="${ISO_MNT}/assets/v2k/wheels"
                      if [[ -d "${WHEEL_DIR}" ]]; then
                          echo "[INFO] Installing pyvmomi from offline wheels: ${WHEEL_DIR}"

                          # 4-A) Try system-wide install first (best for sys.path compatibility)
                          if python3 -m pip --version >/dev/null 2>&1; then
                              if sudo python3 -m pip install --no-index --find-links "${WHEEL_DIR}" pyvmomi; then
                                  echo "[OK] pyvmomi installed into system site-packages (python3 -m pip)."
                              else
                                  echo "[WARN] System-wide pip install failed. Falling back to venv + .pth link."
                              fi
                          else
                              echo "[WARN] System pip not available. Falling back to venv + .pth link."
                          fi

                          # 4-B) If still not importable, install into dedicated venv and link into system via .pth
                          if ! python3 -c 'import pyVmomi' >/dev/null 2>&1; then
                              sudo mkdir -p /usr/share/ablestack/v2k
                              if [[ ! -d /usr/share/ablestack/v2k/venv ]]; then
                                  if ! sudo python3 -m venv /usr/share/ablestack/v2k/venv >/dev/null 2>&1; then
                                      echo "[WARN] python3 venv creation failed. Ensure python3 is installed."
                                  fi
                              fi

                              if [[ -x /usr/share/ablestack/v2k/venv/bin/pip ]]; then
                                  sudo /usr/share/ablestack/v2k/venv/bin/pip install --no-index --find-links "${WHEEL_DIR}" pyvmomi || true
                                  echo "[INFO] pyvmomi installed into venv: /usr/share/ablestack/v2k/venv"
                              else
                                  echo "[WARN] venv pip not found; pyvmomi venv install skipped."
                              fi

                              # Create .pth file to add venv site-packages to system python sys.path
                              if python3 -c 'import sys,sysconfig; print(sysconfig.get_paths()["purelib"])' >/dev/null 2>&1; then
                                  SYS_PURELIB="$(python3 -c 'import sysconfig; print(sysconfig.get_paths()["purelib"])')"
                                  PYVER="$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')"
                                  VENV_SITE="/usr/share/ablestack/v2k/venv/lib/python${PYVER}/site-packages"
                                  if [[ -d "${SYS_PURELIB}" && -d "${VENV_SITE}" ]]; then
                                      PTH_FILE="${SYS_PURELIB}/ablestack-v2k.pth"
                                      echo "${VENV_SITE}" | sudo tee "${PTH_FILE}" >/dev/null
                                      sudo chmod 0644 "${PTH_FILE}"
                                      echo "[OK] Linked venv site-packages into system python via: ${PTH_FILE}"
                                  else
                                      echo "[WARN] Cannot create .pth link (missing dirs): SYS_PURELIB=${SYS_PURELIB}, VENV_SITE=${VENV_SITE}"
                                  fi
                              else
                                  echo "[WARN] sysconfig purelib detection failed; .pth link skipped."
                              fi
                          fi

                          # Final verification
                          if python3 -c 'import pyVmomi; import pyVim' >/dev/null 2>&1; then
                              echo "[OK] pyvmomi import check passed (system python3)."
                          else
                              echo "[WARN] pyvmomi still not importable by system python3."
                              echo "       You can run: python3 -c 'import sys; print(sys.path)' for diagnostics."
                          fi
                      else
                          echo "[WARN] pyvmomi wheels dir not found in ISO: ${WHEEL_DIR}"
                      fi
                  fi

                  ;;
              ubuntu|debian)
                  echo "[INFO] Detected DEB-based system ($DISTRO $MAJOR_VERSION)"
                  UBUNTU_DIR="${MAJOR_VERSION}.04"
                  REPO_PATH=$(realpath "$ISO_MNT/deb/deb-ubuntu${UBUNTU_DIR}")
                  LIST_FILE=/etc/apt/sources.list.d/ablestack-qemu-exec-tools.list
                  echo "deb [trusted=yes] file://$REPO_PATH stable main" | sudo tee $LIST_FILE >/dev/null
                  sudo apt-get update
                  sudo apt-get -y install ablestack-qemu-exec-tools
                  sudo rm -f /etc/apt/sources.list.d/ablestack-qemu-exec-tools.list
                  sudo apt-get update
                  ;;
              *)
                  echo "[ERROR] Unsupported distribution: $DISTRO"
                  exit 1
                  ;;
          esac

          # --- ÏÑ§Ïπò Ï†àÏ∞® ÎÅù ---
          mkdir -p /var/lib/ablestack
          echo ok > /var/lib/ablestack/autoinstall.done
          echo "[INFO] Installation complete."
          EOF
          chmod +x release/install-linux.sh

      - name: Sanity check generated install-linux.sh
        run: |
          set -e
          bash -n release/install-linux.sh

      - name: Generate release notes (changelog)
        run: |
          set -e

          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          DESC="ABLESTACK VM Tools - Auto-built offline ISO for RPM (Rocky/RHEL 9,10), DEB (Ubuntu 22.04/24.04) and Windows (VirtIO Guest Tools + ablestack MSI)."

          echo "# ablestack-qemu-exec-tools ${CURRENT_TAG}" > release_notes.md
          echo >> release_notes.md
          echo "${DESC}" >> release_notes.md
          echo >> release_notes.md

          # ÌÉúÍ∑∏ Ï†ïÎ≥¥ Î≥¥Í∞ï (ÌòπÏãú Î™∞ÎùºÏÑú)
          git fetch --tags --force || true

          # ÏßÅÏ†Ñ ÌÉúÍ∑∏ Ï∞æÍ∏∞ (ÏóÜÏúºÎ©¥ ÏµúÏ¥à Î¶¥Î¶¨Ï¶àÎ°ú Í∞ÑÏ£º)
          PREV_TAG="$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || true)"

          if [ -z "$PREV_TAG" ]; then
            echo "## Changes" >> release_notes.md
            git log --oneline "${CURRENT_TAG}" -- . | sed 's/^/- /' >> release_notes.md
          else
            echo "## Changes since ${PREV_TAG}" >> release_notes.md
            git log --oneline "${PREV_TAG}..${CURRENT_TAG}" -- . | sed 's/^/- /' >> release_notes.md
          fi

          echo "===== Generated release_notes.md ====="
          cat release_notes.md

      - name: Generate ISO
        run: |
          VERSION=${GITHUB_REF##*/}
          mkisofs -o ablestack-qemu-exec-tools-${VERSION}.iso \
            -V "ABLESTACK-Tools" \
            -r -J release
          mkdir -p build/iso
          mv ablestack-qemu-exec-tools-${VERSION}.iso build/iso/
          ls -lh build/iso

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          files: |
            build/iso/*.iso
            release/rpm/rpm-rocky9/ablestack-qemu-exec-tools-*.rpm
            release/v2k/v2k-rpm-rocky9.6/ablestack_v2k-*.rpm
