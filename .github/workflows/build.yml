name: Build and Release ablestack-qemu-exec-tools

on:
  push:
    tags:
      - "v*"

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1) RPM BUILD (Rocky 9 + 10 ë³‘í–‰)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-rpm:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os_version: [9, 10]
    container:
      image: rockylinux/rockylinux:${{ matrix.os_version }}
      options: --user 0
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        run: |
          set -e
          # ðŸ”§ Rocky 10.1 ì´í›„ rpm-sequoia + OpenSSL ì¡°í•©ì´ ë°”ë€Œë©´ì„œ
          # ì»¨í…Œì´ë„ˆ ë² ì´ìŠ¤ ë ˆì´ì–´ì™€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ì´ ì–´ê¸‹ë‚˜ëŠ” ê²½ìš°ê°€ ìžˆì–´
          # â†’ ë¨¼ì € distro-sync ë¡œ rpm / openssl ê³„ì—´ì„ ë¦¬í¬ ìƒíƒœì™€ ë§žì¶˜ë‹¤.
          dnf -y distro-sync

          # ë¹Œë“œì— í•„ìš”í•œ ë„êµ¬ ì„¤ì¹˜
          dnf -y install make rpm-build tar git dnf-plugins-core createrepo_c

      - name: Build RPM
        run: make rpm

      - name: Create RPM repo (with dependencies) for Rocky ${{ matrix.os_version }}
        run: |
          set -e
          WORKDIR="repo/rpm-rocky${{ matrix.os_version }}"
          mkdir -p "$WORKDIR"

          # ë³¸ì²´ RPM ë³µì‚¬
          cp rpmbuild/RPMS/*/*.rpm "$WORKDIR"/

          echo "[INFO] Downloading runtime dependencies..."
          # specì˜ Requiresë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì˜ì¡´ì„± ì „ë¶€ ëª¨ì•„ ì €ìž¥
          dnf download --resolve --alldeps \
            --destdir="$WORKDIR" \
            bash jq libvirt-client cloud-init || true

          echo "[INFO] Creating repo metadata..."
          createrepo_c "$WORKDIR"

          # ì•„í‹°íŒ©íŠ¸ ë””ë ‰í† ë¦¬ ì •ë¦¬
          mkdir -p release/rpm
          mv repo release/rpm/

      - uses: actions/upload-artifact@v4
        with:
          name: rpm-package-${{ matrix.os_version }}
          path: release/rpm/**

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1-B) V2K RPM BUILD (ë³„ë„ ê²½ë¡œ, ê¸°ì¡´ ë¹Œë“œ í”„ë¡œì„¸ìŠ¤ í›¼ì† ê¸ˆì§€)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-v2k-rpm:
    runs-on: ubuntu-latest
    container:
      image: rockylinux/rockylinux:9
      options: --user 0
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps (v2k)
        run: |
          set -euo pipefail

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Rocky 9.6 vault ê³ ì • (AirGap ìˆ˜ì§‘ìš©)
          # - ê¸°ì¡´ rocky.repoëŠ” mirrorlistë§Œ ìžˆê³  baseurlì´ ì—†ì„ ìˆ˜ ìžˆìŒ
          # - releasever=9.6ë§Œìœ¼ë¡œëŠ” í•´ê²° ì•ˆë¨ (baseurlì´ ì—†ì–´ì„œ)
          # - ë”°ë¼ì„œ 9.6 vault baseurlì„ ê°€ì§„ repoë¥¼ "ì§ì ‘" ìƒì„±
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          cat > /etc/yum.repos.d/rocky-vault-9.6.repo <<'EOF'
          [rocky-vault-9.6-baseos]
          name=Rocky Linux 9.6 - BaseOS (vault)
          baseurl=https://dl.rockylinux.org/vault/rocky/9.6/BaseOS/$basearch/os/
          enabled=1
          gpgcheck=0

          [rocky-vault-9.6-appstream]
          name=Rocky Linux 9.6 - AppStream (vault)
          baseurl=https://dl.rockylinux.org/vault/rocky/9.6/AppStream/$basearch/os/
          enabled=1
          gpgcheck=0

          [rocky-vault-9.6-crb]
          name=Rocky Linux 9.6 - CRB (vault)
          baseurl=https://dl.rockylinux.org/vault/rocky/9.6/CRB/$basearch/os/
          enabled=1
          gpgcheck=0
          EOF

          dnf clean all
          dnf -y --disablerepo="*" --enablerepo="rocky-vault-9.6-*" makecache

          # curl ì¶©ëŒ íšŒí”¼: curl-minimal â†” curl
          # - ì»¨í…Œì´ë„ˆ ë² ì´ìŠ¤ì— curl-minimalì´ ê¹”ë¦° ê²½ìš°, í•„ìš” ì‹œ allowerasingìœ¼ë¡œ ì •ë¦¬
          dnf -y --disablerepo="*" --enablerepo="rocky-vault-9.6-*" install \
            --allowerasing ca-certificates curl-minimal || true

          dnf -y --disablerepo="*" --enablerepo="rocky-vault-9.6-*" install \
            make rpm-build tar git dnf-plugins-core createrepo_c

      - name: Configure Rocky 9.6 vault repos + enable EPEL (build-time only)
        run: |
          set -euo pipefail

          # â— í•µì‹¬: rocky.repoë¥¼ "rewrite"í•˜ì§€ ì•ŠëŠ”ë‹¤.
          # rocky.repoëŠ” mirrorlistë§Œ ìžˆê³  baseurlì´ ì—†ëŠ” ì¼€ì´ìŠ¤ê°€ ìžˆì–´
          # mirrorlistë¥¼ ì£¼ì„ ì²˜ë¦¬í•˜ë©´ "baseurl ì—†ìŒ"ìœ¼ë¡œ dnfê°€ ì¦‰ì‹œ ì‹¤íŒ¨í•œë‹¤.
          # ë”°ë¼ì„œ 9.6 vault baseurlì„ ê°€ì§„ repo íŒŒì¼ì„ ë³„ë„ë¡œ ìƒì„±í•´ì„œ ì‚¬ìš©í•œë‹¤.

          cat > /etc/yum.repos.d/rocky-vault-9.6.repo <<'EOF'
          [rocky-vault-9.6-baseos]
          name=Rocky Linux 9.6 - BaseOS (vault)
          baseurl=https://dl.rockylinux.org/vault/rocky/9.6/BaseOS/$basearch/os/
          enabled=1
          gpgcheck=0

          [rocky-vault-9.6-appstream]
          name=Rocky Linux 9.6 - AppStream (vault)
          baseurl=https://dl.rockylinux.org/vault/rocky/9.6/AppStream/$basearch/os/
          enabled=1
          gpgcheck=0

          [rocky-vault-9.6-crb]
          name=Rocky Linux 9.6 - CRB (vault)
          baseurl=https://dl.rockylinux.org/vault/rocky/9.6/CRB/$basearch/os/
          enabled=1
          gpgcheck=0
          EOF

          echo "[INFO] Enabled repos (vault 9.6):"
          grep -nE '^\[|^baseurl=' /etc/yum.repos.d/rocky-vault-9.6.repo

          # vault repoë§Œìœ¼ë¡œ ìºì‹œ ìƒì„±
          dnf -y --disablerepo="*" --enablerepo="rocky-vault-9.6-*" makecache

          # EPELì€ build-time only (nbd ë“± ìˆ˜ì§‘ ëª©ì ) â†’ ì—¬ê¸°ì„œ í™œì„±í™” ê°€ëŠ¥
          # â— vault repoë§Œ ì¼  ìƒíƒœì—ì„œëŠ” epel-release íŒ¨í‚¤ì§€ë¥¼ 'dnf install'ë¡œ ì°¾ì„ ìˆ˜ ì—†ìŒ(No match).
          #     â†’ EPEL bootstrap rpmì„ URLë¡œ ì§ì ‘ ì„¤ì¹˜í•œë‹¤.
          #     (ë¹Œë“œ/ë¦´ë¦¬ì¦ˆ ë‹¨ê³„ì—ì„œë§Œ ì™¸ë¶€ ì ‘ê·¼ í—ˆìš©í•˜ê³ , ê²°ê³¼ rpmì€ ISOì— í¬í•¨)
          EPEL_RPM_URL="https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm"
          echo "[INFO] Installing EPEL release RPM: ${EPEL_RPM_URL}"
          curl -fL -o /tmp/epel-release.rpm "${EPEL_RPM_URL}"
          rpm -Uvh --nosignature /tmp/epel-release.rpm

          # EPEL repo id ìžë™ íƒì§€(epel/epel-9/epel-next ë“± ì¼€ì´ìŠ¤ ëŒ€ì‘)
          EPEL_REPO_ID="$(dnf repolist all 2>/dev/null | awk 'tolower($1) ~ /^epel/ {print $1; exit}')"
          if [[ -z "${EPEL_REPO_ID}" ]]; then
            echo "[ERR] EPEL repo id not found after installing epel-release." >&2
            dnf repolist all || true
            exit 2
          fi
          echo "[INFO] Detected EPEL repo id: ${EPEL_REPO_ID}"
          echo "EPEL_REPO_ID=${EPEL_REPO_ID}" >> "$GITHUB_ENV"

          # vault + epel ìºì‹œ ìƒì„±(ë”± í•„ìš”í•œ repoë§Œ)
          dnf -y --disablerepo="*" --enablerepo="rocky-vault-9.6-*","${EPEL_REPO_ID}" makecache          

      - name: Build V2K RPM (separate path)
        run: |
          set -e
          # NOTE: ê¸°ì¡´ make rpm ê²½ë¡œì™€ ë¶„ë¦¬ëœ V2K ì „ìš© íƒ€ê²Ÿì„ ì‚¬ìš©í•´ì•¼ í•¨
          #       (ì˜ˆ: make v2k-rpm)
          make v2k-rpm

      - name: Create V2K RPM repo (offline) for ABLESTACK (Rocky 9.6)
        run: |
          set -e
          WORKDIR="release/v2k/v2k-rpm-rocky9.6"
          mkdir -p "$WORKDIR"

          # V2K ë³¸ì²´ RPM ìˆ˜ì§‘ (í”„ë¡œì íŠ¸ ì‚°ì¶œ ê²½ë¡œì— ë§žì¶° í•„ìš” ì‹œ ì¡°ì •)
          find . -type f -name "*.rpm" \( -iname "*ablestack*v2k*.rpm" -o -iname "*ablestack-v2k*.rpm" \) -exec cp -v {} "$WORKDIR"/ \;

          echo "[INFO] Collecting runtime deps for Air-Gap (Requires closure minus ABLESTACK baseline)..."

          # --- 9.6 ê³ ì • (ì¤‘ìš”: 9.7 í˜¼ìž… ì°¨ë‹¨) ---
          : "${EPEL_REPO_ID:?EPEL_REPO_ID is not set. Configure step must export it to GITHUB_ENV}"
          # ì˜µì…˜ ë¬¸ìžì—´ì— ë”°ì˜´í‘œë¥¼ ë„£ì§€ ë§ê³ , ë°°ì—´ë¡œ ì „ë‹¬(íŒŒì‹± ì•ˆì •ì„±)
          DNF_COMMON_OPTS=(
            --releasever=9.6
            --disablerepo=*
            --enablerepo="rocky-vault-9.6-*","${EPEL_REPO_ID}"
            --setopt=install_weak_deps=False
          )

          # ablestack-v2k.specì˜ Requiresì™€ ë™ì¼í•˜ê²Œ ìœ ì§€ (8ê°œ)
          # ceph-common: rbd CLI ì‚¬ìš©(ìƒì„±/ì¡´ìž¬í™•ì¸) ëª©ì 
          REQ_PKGS="jq python3 openssl nbd nbdkit nbdkit-vddk-plugin qemu-img libvirt-client"

          # baseline íŒŒì¼(ABLestack 9.6 í˜¸ìŠ¤íŠ¸ì—ì„œ rpm -qa ê¸°ë°˜ìœ¼ë¡œ ìƒì„±í•´ ì»¤ë°‹)
          BASELINE_FILE="rpm/v2k_baseline_pkgs_ablestack_9.6.txt"
          if [[ ! -f "${BASELINE_FILE}" ]]; then
            echo "[ERR] Missing baseline file: ${BASELINE_FILE}" >&2
            echo "      Generate on ABLESTACK 9.6 host:" >&2
            echo "        rpm -qa --qf '%{NAME}\\n' | sort -u > ${BASELINE_FILE}" >&2
            exit 2
          fi

          echo "[INFO] Sanity check: required pkgs availability (repo view)"
          # nbd/nbdkit/qemu-imgê°€ repoì—ì„œ ì•ˆ ë³´ì´ë©´ ì—¬ê¸°ì„œ ì¦‰ì‹œ ì‹¤íŒ¨í•´ì•¼ í•¨(ì§€ê¸ˆ ë¬¸ì œ ì¡°ê¸° ì°¨ë‹¨)
          dnf -q "${DNF_COMMON_OPTS[@]}" repoquery --available ${REQ_PKGS} >/dev/null

          # Requires ì˜ì¡´ì„± í´ë¡œì € ì‚°ì¶œ (íŒ¨í‚¤ì§€ëª…ë§Œ, ì¤‘ë³µ ì œê±°)
          # dnf-plugins-coreì˜ repoquery ì‚¬ìš©
          dnf -y "${DNF_COMMON_OPTS[@]}" install dnf-plugins-core >/dev/null
          dnf -q "${DNF_COMMON_OPTS[@]}" repoquery \
            --requires --resolve --recursive \
            --qf '%{name}' \
            ${REQ_PKGS} | sort -u > /tmp/v2k_dep_closure.txt

          # (ì¤‘ìš”) Direct requiresëŠ” baseline subtractì™€ ë¬´ê´€í•˜ê²Œ ë°˜ë“œì‹œ í¬í•¨
          printf '%s\n' ${REQ_PKGS} | sort -u > /tmp/v2k_must_have.txt


          # baselineì— ì´ë¯¸ ìžˆëŠ” íŒ¨í‚¤ì§€ ì œì™¸ (ì—†ëŠ” ê²ƒë§Œ ë‹¤ìš´ë¡œë“œ)
          sort -u "${BASELINE_FILE}" > /tmp/v2k_baseline.txt
          comm -23 /tmp/v2k_dep_closure.txt /tmp/v2k_baseline.txt > /tmp/v2k_to_download_closure.txt

          # must-have + (closure-baseline) í•©ì§‘í•© = ìµœì¢… ë‹¤ìš´ë¡œë“œ ëª©ë¡
          cat /tmp/v2k_must_have.txt /tmp/v2k_to_download_closure.txt | sort -u > /tmp/v2k_to_download.txt

          echo "[INFO] Dep closure count: $(wc -l < /tmp/v2k_dep_closure.txt)"
          echo "[INFO] Baseline count:    $(wc -l < /tmp/v2k_baseline.txt)"
          echo "[INFO] To-download count:$(wc -l < /tmp/v2k_to_download.txt)"
          echo "[INFO] To-download sample (first 50):"
          head -n 50 /tmp/v2k_to_download.txt || true

          grep -n '^nbd$' /tmp/v2k_to_download.txt || true
          grep -n '^nbd$' /tmp/v2k_baseline.txt || true

          if [[ -s /tmp/v2k_to_download.txt ]]; then
            # ì‹¤íŒ¨ë¥¼ ìˆ¨ê¸°ì§€ ì•ŠëŠ”ë‹¤. (nbd ë¯¸í¬í•¨ì¸ë°ë„ ì„±ê³µ ì²˜ë¦¬ë˜ëŠ” ê²ƒì„ ë°©ì§€)
            xargs -r dnf "${DNF_COMMON_OPTS[@]}" --exclude=glibc-langpack-\* --exclude=glibc-all-langpacks download --destdir="$WORKDIR" < /tmp/v2k_to_download.txt
          else
            echo "[INFO] Nothing to download (all deps satisfied by baseline)."
          fi

          # ìµœì¢… ê²€ì¦: nbd/nbdkit/qemu-img rpmì´ ì‹¤ì œë¡œ ë“¤ì–´ì™”ëŠ”ì§€ í™•ì¸
          ls -1 "$WORKDIR"/nbd-*.rpm "$WORKDIR"/nbdkit-*.rpm "$WORKDIR"/qemu-img-*.rpm >/dev/null
          
          echo "[INFO] Creating repo metadata..."
          createrepo_c "$WORKDIR"

      - uses: actions/upload-artifact@v4
        with:
          name: v2k-rpm-package
          path: release/v2k/**

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2) DEB BUILD (Ubuntu 22.04 / 24.04)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-deb:
    strategy:
      matrix:
        os_version: [22.04, 24.04]
    runs-on: ubuntu-${{ matrix.os_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential make dpkg-dev debhelper git apt-utils

      - name: Build DEB
        run: make deb

      - name: Download dependencies and create APT repo
        run: |
          set -e
          sudo apt-get update -y

          # ISOìš© ë¡œì»¬ APT ë¦¬í¬ ìƒì„± ê³µê°„
          mkdir -p repo/pool
          find build/deb -type f -name "*.deb" -exec cp {} repo/pool/ \;

          cd repo/pool

          echo "[INFO] Starting dependency collection..."
          # ì´ë¯¸ ì²˜ë¦¬í•œ íŒ¨í‚¤ì§€ ì´ë¦„ ê¸°ì–µ
          seen_pkgs=""
          # ìƒˆ .debì´ ì¶”ê°€ë˜ëŠ” ë™ì•ˆ ë°˜ë³µ
          new_pkgs=1
          while [ "$new_pkgs" -eq 1 ]; do
            new_pkgs=0
            for deb in *.deb; do
              [ -e "$deb" ] || continue
              P=$(dpkg-deb -f "$deb" Package)
              if echo "$seen_pkgs" | grep -qw "$P"; then
                continue
              fi
              seen_pkgs="$seen_pkgs $P"

              # Depends íŒŒì‹±: ì½¤ë§ˆ ë¶„ë¦¬, ë²„ì „/ê´„í˜¸ ì œê±°, ëŒ€ì²´(|)ëŠ” ì²« í† í°, :any ì œê±°
              DEPS=$(dpkg-deb -f "$deb" Depends | \
                     tr ',' '\n'          | \
                     sed -E 's/\(.*\)//g' | \
                     sed 's/|/ /g'        | \
                     sed 's/:any//g'      | \
                     awk '{print $1}'     | \
                     grep -v '^$'         | \
                     sort -u)
              echo "[INFO] [$P] depends on: $DEPS"

              for dep in $DEPS; do
                [ -n "$dep" ] || continue
                # ì´ë¯¸ poolì— ê°™ì€ íŒ¨í‚¤ì§€ ë‚´ë ¤ë°›ì€ ê²½ìš°ëŠ” ë„˜ì–´ê°
                if ls -1 ${dep}_*.deb >/dev/null 2>&1; then
                  continue
                fi
                echo "[INFO] Downloading: $dep"
                if apt-get download "$dep"; then
                  new_pkgs=1
                else
                  echo "[WARN] Failed to download: $dep"
                fi
              done
            done
          done

          echo "[INFO] Total pool count: $(ls -1 *.deb | wc -l)"

          cd ../..
          # ì¸ë±ìŠ¤ ìƒì„± (repo ë£¨íŠ¸ì—ì„œ ì‹¤í–‰í•´ì•¼ Filename ê²½ë¡œê°€ pool/ ë¡œ ë§žìŒ)
          mkdir -p repo/dists/stable/main/binary-amd64
          ( cd repo && dpkg-scanpackages pool /dev/null | gzip -9c > dists/stable/main/binary-amd64/Packages.gz )

          # ë°°í¬ìš© ìœ„ì¹˜ë¡œ ì •ë¦¬
          mv repo "deb-ubuntu${{ matrix.os_version }}"
          mkdir -p release/deb
          mv deb-ubuntu${{ matrix.os_version }} release/deb/

      - uses: actions/upload-artifact@v4
        with:
          name: deb-package-${{ matrix.os_version }}
          path: release/deb/**

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3) WINDOWS MSI BUILD
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install WiX v4
        run: dotnet tool install --global wix --version 4.*

      - name: Add dotnet tools to PATH
        shell: pwsh
        run: echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build MSI
        shell: pwsh
        run: make windows

      - uses: actions/upload-artifact@v4
        with:
          name: msi-package
          path: windows/msi/out/*

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4) RELEASE + ISO CREATION (VirtIO í†µí•© í¬í•¨)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    needs: [build-rpm, build-deb, build-windows, build-v2k-rpm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # dist/ ì•„ëž˜ì— ëª¨ë“  ì•„í‹°íŒ©íŠ¸ ë‚´ë ¤ë°›ê¸°
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Install packaging tools (genisoimage, 7zip)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y genisoimage p7zip-full python3-pip

      - name: Collect artifacts into structured dirs
        run: |
          set -e
          mkdir -p release/rpm release/deb release/msi release/assets/v2k/wheels release/v2k

          echo "ðŸ” Collecting RPM repos..."
          for ver in 9 10; do
            SRC_DIR=$(find dist -type d -path "*/rpm-package-${ver}/release/rpm/repo/rpm-rocky${ver}" | head -n 1)
            if [ -d "$SRC_DIR" ]; then
              echo "[INFO] Found $SRC_DIR"
              mkdir -p release/rpm/rpm-rocky${ver}
              cp -r "$SRC_DIR"/* release/rpm/rpm-rocky${ver}/
            else
              SRC_DIR=$(find dist -type d -path "*/rpm-package-${ver}/repo/rpm-rocky${ver}" | head -n 1)
              if [ -d "$SRC_DIR" ]; then
                echo "[INFO] Found (fallback) $SRC_DIR"
                mkdir -p release/rpm/rpm-rocky${ver}
                cp -r "$SRC_DIR"/* release/rpm/rpm-rocky${ver}/
              else
                echo "[WARN] No RPM repo found for version ${ver}"
              fi
            fi
          done

          echo "ðŸ” Collecting DEB repos..."
          for ver in 22.04 24.04; do
            SRC_DIR=$(find dist -type d \( \
                        -path "*/deb-package-${ver}/release/deb/deb-ubuntu${ver}" -o \
                        -path "*/deb-package-${ver}/deb-ubuntu${ver}" \
                      \) | head -n 1)
            if [ -d "$SRC_DIR" ]; then
              echo "[INFO] Found $SRC_DIR"
              mkdir -p release/deb/deb-ubuntu${ver}
              cp -r "$SRC_DIR"/* release/deb/deb-ubuntu${ver}/
            else
              echo "[WARN] No DEB repo found for version ${ver}"
            fi
          done

          echo "ðŸ” Collecting MSI artifacts..."
          find dist -type f -path "*/msi-package/*" -exec cp {} release/msi/ \;

      - name: Collect V2K RPM repo (Rocky 9.6) into ISO tree
        shell: bash
        run: |
          set -euo pipefail
          # build-v2k-rpm outputs: release/v2k/v2k-rpm-rocky9.6
          SRC_DIR=$(find dist -type d -path "*/v2k-rpm-package/v2k-rpm-rocky9.6" -o -path "*/v2k-rpm-package/release/v2k/v2k-rpm-rocky9.6" | head -n 1 || true)
          if [[ -z "${SRC_DIR}" || ! -d "${SRC_DIR}" ]]; then
            echo "[ERR] No V2K RPM repo found in workflow artifacts." >&2
            echo "[ERR] Debug: listing dist/v2k-rpm-package tree (maxdepth=6)" >&2
            find dist -maxdepth 6 -path "*v2k-rpm-package*" -print >&2 || true
            exit 2
          fi

          echo "[INFO] Found V2K repo: ${SRC_DIR}"
          mkdir -p release/v2k/v2k-rpm-rocky9.6
          # Preserve repodata/ and all rpm files
          cp -a "${SRC_DIR}/." release/v2k/v2k-rpm-rocky9.6/

      - name: Stage V2K assets from repo ./assets into ISO (govc, VDDK)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release/assets
          cp -v assets/govc_Linux_x86_64.tar.gz release/assets/ || true
          cp -v assets/VMware-vix-disklib-*.tar.gz release/assets/ || true

      - name: Prepare pyvmomi offline wheels (Air-Gap)
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip download -d release/assets/v2k/wheels "pyvmomi==8.0.3.0.1"

      # VirtIO Windows Stable ISO ë‹¤ìš´ë¡œë“œ í›„ "amd64 ë“œë¼ì´ë²„ + guest tools(qemu-ga í¬í•¨)"ë§Œ ì¶”ì¶œ
      # - ì¤‘ì²© ISO ê¸ˆì§€
      # - DISM/WinPEì—ì„œ ë°”ë¡œ INF ê²½ë¡œ ì§€ì • ê°€ëŠ¥
      # - ìš©ëŸ‰ ì ˆê°(amd64 only)
      - name: Download & extract VirtIO (amd64-only + guest tools)
        run: |
          set -e
          mkdir -p dist/virtio-src release/virtio
          curl -fL -o dist/virtio-win.iso \
            "https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso"

          # 1) DISMìš©: í•µì‹¬ ë“œë¼ì´ë²„ ë””ë ‰í† ë¦¬ì˜ amd64ë§Œ ì¶”ì¶œ
          #    (VirtIO ISO ë²„ì „ì— ë”°ë¼ w11/2k22/2k19 ë“± í•˜ìœ„ í´ë”ëª…ì´ ë‹¬ë¼ë„, amd64 ê²½ë¡œë§Œ ì‚´ë¦¬ë©´ ëœë‹¤)
          #    7zëŠ” ì™€ì¼ë“œì¹´ë“œ íŒ¨í„´ì„ í—ˆìš©í•˜ë¯€ë¡œ, */amd64/* íŒ¨í„´ìœ¼ë¡œ ì¶”ì¶œí•œë‹¤.
          7z x -y -o"dist/virtio-src" dist/virtio-win.iso \
            "viostor/*/amd64/*" \
            "vioscsi/*/amd64/*" \
            "NetKVM/*/amd64/*" \
            "Balloon/*/amd64/*" \
            "qemupciserial/*/amd64/*" \
            "viorng/*/amd64/*" \
            "pvpanic/*/amd64/*" \
            "vioinput/*/amd64/*" \
            "vioser/*/amd64/*" || true

          # 2) Guest tools(qemu-ga í¬í•¨): exe/msiëŠ” ë£¨íŠ¸ ë˜ëŠ” íŠ¹ì • ìœ„ì¹˜ì— ìžˆì„ ìˆ˜ ìžˆìœ¼ë¯€ë¡œ 'ì°¾ì•„ì„œ' í¬í•¨
          #    - ë‘˜ ë‹¤ ìžˆìœ¼ë©´ ë‘˜ ë‹¤ í¬í•¨(í˜„ìž¥ ì„ íƒ ê°€ëŠ¥)
          7z x -y -o"dist/virtio-src" dist/virtio-win.iso "virtio-win-guest-tools.exe" || true
          7z x -y -o"dist/virtio-src" dist/virtio-win.iso "virtio-win-gt-*.msi" || true

          # 3) release/virtioë¡œ ë³µì‚¬ (ì¡´ìž¬í•˜ëŠ” ê²ƒë§Œ)
          for d in viostor vioscsi NetKVM Balloon qemupciserial viorng pvpanic vioinput vioser; do
            if [[ -d "dist/virtio-src/${d}" ]]; then
              mkdir -p "release/virtio/${d}"
              cp -a "dist/virtio-src/${d}/." "release/virtio/${d}/"
            fi
          done
          if [[ -f "dist/virtio-src/virtio-win-guest-tools.exe" ]]; then
            cp -a "dist/virtio-src/virtio-win-guest-tools.exe" "release/virtio/"
          fi
          # MSIëŠ” ë²„ì „ë³„ íŒŒì¼ëª…ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìžˆì–´ glob ë³µì‚¬
          shopt -s nullglob
          for m in dist/virtio-src/virtio-win-gt-*.msi; do
            cp -a "$m" "release/virtio/"
          done
          shopt -u nullglob

          echo "[INFO] virtio payload size:"
          du -sh release/virtio || true
          echo "[INFO] sample INF files:"
          find release/virtio -type f -name '*.inf' | head -n 30 || true

      # Windows ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ë£¨íŠ¸: install.ps1/install.bat)
      - name: Create Windows installer scripts
        shell: bash
        run: |
          cat > release/install.ps1 << 'PS1'
          Param(
            [switch]$Silent
          )

          # Force default = false if not provided
          if (-not $PSBoundParameters.ContainsKey('Silent')) {
            $Silent = $false
          }

          # Debug print
          Write-Host "[DEBUG] Silent mode: $Silent"

          function Ensure-Admin {
            $id = [Security.Principal.WindowsIdentity]::GetCurrent()
            $p  = New-Object Security.Principal.WindowsPrincipal($id)
            if (-not $p.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
              Write-Host "[INFO] Elevation required. Re-launching as Administrator..."
              $psi = New-Object System.Diagnostics.ProcessStartInfo
              $psi.FileName  = "powershell.exe"
              $psi.Arguments = "-NoProfile -ExecutionPolicy Bypass -File `"$($MyInvocation.MyCommand.Path)`" " + ($args -join ' ')
              $psi.Verb = "runas"
              [Diagnostics.Process]::Start($psi) | Out-Null
              exit
            }
          }

          # WinForms GUI setup
          $Global:GuiReady = $false
          try {
            Add-Type -AssemblyName System.Windows.Forms -ErrorAction Stop
            $Global:GuiReady = $true
          } catch {
            $Global:GuiReady = $false 
            Write-Host "[WARN] Cannot load System.Windows.Forms. GUI dialogs will be disabled."
          }

          function Show-Info([string]$text) {
            if ($Global:GuiReady -and -not $Silent) {
              [void][System.Windows.Forms.MessageBox]::Show(
                $text,
                "ABLESTACK Installer",
                [System.Windows.Forms.MessageBoxButtons]::OK,
                [System.Windows.Forms.MessageBoxIcon]::Information
              )
            } else {
              Write-Host $text
            }
          }

          function Prompt_Reboot {
              param(
                  [string]$Message = "ABLESTACK tools installation is complete. The system needs to reboot.",
                  [string]$Title   = "ABLESTACK",
                  [int]   $Options = 0x0,     # 0x0: OK only / 0x4: Yes/No ë“±
                  [int]   $TimeoutSeconds = 60  # ì‚¬ìš©ìž ìž…ë ¥ ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ (ì´ˆ)
              )

              $shell = New-Object -ComObject WScript.Shell

              # ë‘ ë²ˆì§¸ ì¸ìžì— íƒ€ìž„ì•„ì›ƒ(ì´ˆ)ì„ ë„£ëŠ”ë‹¤.
              # ë°˜í™˜ê°’:
              #   -1 : íƒ€ìž„ì•„ì›ƒ
              #    1 : OK
              #    6 : Yes (0x4 ì˜µì…˜ì¼ ë•Œ)
              $result = $shell.Popup($Message, $TimeoutSeconds, $Title, $Options)

              if ($result -eq -1 -or $result -eq 1 -or $result -eq 6) {
                  Write-Host "Prompt_Reboot: user accepted or no response within timeout. Rebooting..."
                  # ìž¬ë¶€íŒ… ë°”ë¡œ ìˆ˜í–‰ (ì›ëž˜ ìŠ¤íŽ™ëŒ€ë¡œ)
                  Restart-Computer -Force
                  # MSI CustomActionì´ë¼ë©´ ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ
                  #   msiexec /i ... /norestart + REBOOT=ReallySuppress
                  # ë¥¼ ì“°ê³  ì‹œìŠ¤í…œ ìž¬ë¶€íŒ…ì€ ë³„ë„ ê´€ë¦¬ìž ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì²˜ë¦¬í•˜ëŠ” ì‹ë„ ê°€ëŠ¥í•˜ì§€ë§Œ,
                  # ì§€ê¸ˆ êµ¬ì¡°ì—ì„œëŠ” Restart-Computer ì¨ë„ ë¨.
              }
              else {
                  Write-Host "Prompt_Reboot: user canceled reboot (result = $result)."
              }
          }

          Ensure-Admin

          $logPath = "C:\Windows\Temp\ablestack-virtio-install.log"
          Start-Transcript -Path $logPath -Append | Out-Null

          $global:rebootNeeded = $false
          function Handle-MsiExit($code, $component, $logFile) {
            switch ($code) {
              0     { Write-Host "[OK] $component installed."; return }
              3010  { Write-Host "[OK] $component installed. Reboot required (3010)."
                      $global:rebootNeeded = $true; return }
              default { throw "$component install failed with code $code. See $logFile" }
            }
          }

          try {
            $ScriptDir = Split-Path -Path $MyInvocation.MyCommand.Path -Parent
            $VirtioDir = Join-Path $ScriptDir "virtio"
            $MsiDir    = Join-Path $ScriptDir "msi"

            if (-not (Test-Path $MsiDir)) { throw "MSI folder not found: $MsiDir" }

            # Locate VirtIO guest tools EXE
            $candidateExe = @(
              (Join-Path $ScriptDir  "virtio-win-guest-tools.exe"),
              (Join-Path $VirtioDir  "virtio-win-guest-tools.exe")
            ) + (Get-ChildItem -Path $VirtioDir -Recurse -Filter "virtio-win-guest-tools.exe" -ErrorAction SilentlyContinue | Select-Object -Expand FullName)
            $virtioExe = $candidateExe | Where-Object { Test-Path $_ } | Select-Object -First 1

            # MSI fallback
            $candidateMsi = @(
              (Join-Path $ScriptDir "virtio-win-gt-x64.msi"),
              (Join-Path $VirtioDir "virtio-win-gt-x64.msi")
            ) + (Get-ChildItem -Path $VirtioDir -Recurse -Filter "virtio-win-gt-*.msi" -ErrorAction SilentlyContinue | Select-Object -Expand FullName)
            $virtioMsi = $candidateMsi | Where-Object { Test-Path $_ } | Sort-Object -Descending | Select-Object -First 1

            $installOk = $false
            if ($virtioExe) {
              Write-Host "[STEP] Installing VirtIO guest tools (EXE): $virtioExe"
              $exeTry = @('/quiet /norestart','/qn /norestart','/S','/s')
              foreach ($argsStr in $exeTry) {
                Write-Host "  -> Trying args: $argsStr"
                $p = Start-Process -FilePath $virtioExe -ArgumentList $argsStr -PassThru -Wait -NoNewWindow
                if ($p.ExitCode -eq 0 -or $p.ExitCode -eq 3010) {
                  if ($p.ExitCode -eq 3010) { $global:rebootNeeded = $true }
                  $installOk = $true
                  Write-Host "[OK] VirtIO guest tools installed (EXE, code $($p.ExitCode))."
                  break
                } else {
                  Write-Warning "    ExitCode=$($p.ExitCode). Trying next switch..."
                }
              }
            }

            if (-not $installOk) {
              if (-not $virtioMsi) { throw "Neither virtio-win-guest-tools.exe nor virtio-win-gt-*.msi could be executed/found." }
              Write-Host "[STEP] Installing VirtIO guest tools (MSI fallback): $virtioMsi"
              $msiLog = Join-Path $env:TEMP "virtio-win-guest-tools-msi.log"
              $msiArgs = "/i `"$virtioMsi`" /qn /norestart /l*v `"$msiLog`" ADDLOCAL=ALL"
              $p = Start-Process -FilePath "msiexec.exe" -ArgumentList $msiArgs -PassThru -Wait -NoNewWindow
              Handle-MsiExit -code $p.ExitCode -component "VirtIO guest tools (MSI)" -logFile $msiLog
              $installOk = $true
            }

            # Install ablestack MSI
            Write-Host "[STEP] Installing ablestack-qemu-exec-tools (MSI)"
            $execMsi = Get-ChildItem -Path $MsiDir -Filter *.msi | Sort-Object LastWriteTime -Descending | Select-Object -First 1
            if (-not $execMsi) { throw "No ablestack MSI found in $MsiDir" }

            $execLog = Join-Path $env:TEMP "ablestack-qemu-exec-tools-msi.log"
            $execArgs = "/i `"$($execMsi.FullName)`" /qn /norestart /l*v `"$execLog`""
            $p = Start-Process -FilePath "msiexec.exe" -ArgumentList $execArgs -PassThru -Wait -NoNewWindow
            Handle-MsiExit -code $p.ExitCode -component "ablestack-qemu-exec-tools" -logFile $execLog

            # Completion message
            if ($global:rebootNeeded) {
              Prompt_Reboot "ABLESTACK tools installation completed. Reboot now?" "ABLESTACK" 0x0 30
              # â†’ 30ì´ˆë§Œ ê¸°ë‹¤ë¦° ë’¤ ìžë™ ìž¬ë¶€íŒ…
            } else {
              Show-Info "Installation completed successfully. No reboot is required."
            }
          }
          catch {
            Write-Error $_
            exit 1
          }
          finally {
            Stop-Transcript | Out-Null
          }
          PS1

          cat > release/install.bat << 'BAT'
          @echo off
          setlocal
          rem Always run non-silent mode by default
          powershell -NoProfile -ExecutionPolicy Bypass -File "%~dp0install.ps1"
          if errorlevel 1 (
            echo [ERROR] Install failed. See C:\Windows\Temp\ablestack-virtio-install.log
            exit /b 1
          )
          
          REM --- ì„¤ì¹˜ ì ˆì°¨ ë ---
          mkdir "C:\ProgramData\AbleStack" 2>nul
          echo ok> "C:\ProgramData\AbleStack\autoinstall.done"
          echo [OK] Installation finished.
          endlocal
          BAT

      - name: Create README.txt (updated)
        run: |
          cat <<'EOF' > release/README.txt
          ablestack-qemu-exec-tools Offline Installation ISO
          ==================================================
          Contents
            - RPM repos:
                rpm/rpm-rocky9
                rpm/rpm-rocky10
            - DEB repos:
                deb/deb-ubuntu22.04
                deb/deb-ubuntu24.04
            - Windows:
                msi/ (ablestack-qemu-exec-tools .msi)
                virtio/ (VirtIO Windows drivers + Guest Tools from stable-virtio)
            - Universal installer:
                install-linux.sh
            - Windows installers:
                install.bat / install.ps1
            - V2K (ABLESTACK Host add-on):
                v2k/v2k-rpm-rocky9.6 (offline RPM repo for ablestack_v2k)
                assets/govc_Linux_x86_64.tar.gz
                assets/VMware-vix-disklib-*.tar.gz
                assets/v2k/wheels (pyvmomi offline wheels)


          Windows (recommended)
            1) Mount ISO in the Windows VM.
            2) Run install.bat (or install.ps1) as Administrator.
               - Installs VirtIO Guest Tools (drivers & agent) silently.
               - Installs ablestack-qemu-exec-tools (MSI) silently.
            3) Reboot is recommended after completion.

          Linux
            1) mount -o loop ablestack-qemu-exec-tools-<VERSION>.iso /mnt
            2) cd /mnt && sudo ./install-linux.sh
          EOF

      - name: Create install-linux.sh (V2K add-on for ABLESTACK; keep existing flows)
        run: |
          cat <<'EOF' > release/install-linux.sh
          #!/usr/bin/env bash
          set -e
          ISO_MNT=$(dirname "$0")

          echo "[INFO] ABLESTACK QEMU Exec Tools Installer"
          echo "[INFO] Detecting distribution..."

          if [ -f /etc/os-release ]; then
              . /etc/os-release
              DISTRO=$ID
              MAJOR_VERSION=$(echo $VERSION_ID | cut -d'.' -f1)
          else
              echo "[ERROR] Cannot detect distribution!"
              exit 1
          fi

          case "$DISTRO" in
              rocky|rhel|centos|almalinux|fedora)
                  echo "[INFO] Detected RPM-based system ($DISTRO $MAJOR_VERSION)"
                  REPO_FILE=/etc/yum.repos.d/ablestack-qemu-exec-tools.repo
                  REPO_PATH=$(realpath "$ISO_MNT/rpm/rpm-rocky$MAJOR_VERSION")
                  cat <<EOR | sudo tee $REPO_FILE >/dev/null
          [ablestack-qemu-exec-tools]
          name=ablestack-qemu-exec-tools
          baseurl=file://$REPO_PATH
          enabled=1
          gpgcheck=0
          EOR
                  sudo dnf clean all
                  sudo dnf -y --disablerepo="*" --enablerepo="ablestack-qemu-exec-tools" install ablestack-qemu-exec-tools
                  sudo rm -f /etc/yum.repos.d/ablestack-qemu-exec-tools.repo
                  sudo dnf clean all
                  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                  # V2K add-on (ABLESTACK Host only)
                  #  - based on bin/v2k_test_install.sh
                  #  - Air-Gap: pyvmomi installs from ISO offline wheels
                  #  - NO ldconfig / NO global linker path modifications
                  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                  if [[ "${PRETTY_NAME:-}" == *"ABLESTACK"* && "${VERSION_ID:-}" == 9.6* ]]; then
                      echo "[INFO] ABLESTACK 9.6 detected. Installing V2K add-on..."

                      has_cmd() { command -v "$1" >/dev/null 2>&1; }

                      # 1) Install ablestack_v2k RPM from ISO local repo
                      V2K_REPO_DIR="${ISO_MNT}/v2k/v2k-rpm-rocky9.6"
                      if [[ -d "${V2K_REPO_DIR}" ]]; then
                          V2K_REPO_FILE=/etc/yum.repos.d/ablestack-v2k.repo
                          cat <<EOV | sudo tee "${V2K_REPO_FILE}" >/dev/null
          [ablestack-v2k]
          name=ablestack-v2k
          baseurl=file://${V2K_REPO_DIR}
          enabled=1
          gpgcheck=0
          EOV
                          sudo dnf clean all
                          sudo dnf -y --disablerepo="*" --enablerepo="ablestack-v2k" install ablestack-v2k || \
                            sudo dnf -y --disablerepo="*" --enablerepo="ablestack-v2k" install ablestack_v2k || \
                            sudo dnf -y localinstall "${V2K_REPO_DIR}"/*.rpm
                          sudo rm -f "${V2K_REPO_FILE}"
                          sudo dnf clean all
                      else
                          echo "[WARN] V2K RPM repo not found in ISO: ${V2K_REPO_DIR}"
                      fi

                      # 2) govc from ISO assets
                      GOVC_TGZ="${ISO_MNT}/assets/govc_Linux_x86_64.tar.gz"
                      if [[ -f "${GOVC_TGZ}" ]]; then
                          echo "[INFO] Installing govc from asset: ${GOVC_TGZ}"
                          tmp="$(mktemp -d)"
                          tar -xzf "${GOVC_TGZ}" -C "${tmp}"
                          bin="${tmp}/govc"
                          if [[ ! -f "${bin}" ]]; then
                              bin="$(find "${tmp}" -maxdepth 3 -type f -name govc | head -n1 || true)"
                          fi
                          if [[ -f "${bin}" ]]; then
                              sudo install -m 0755 "${bin}" /usr/local/bin/govc
                              echo "[OK] govc installed to /usr/local/bin/govc"
                          else
                              echo "[WARN] govc binary not found inside ${GOVC_TGZ}"
                          fi
                          rm -rf "${tmp}"
                      else
                          echo "[WARN] govc asset not found: ${GOVC_TGZ}"
                      fi

                      # 3) VMware VDDK from ISO assets (NO ldconfig)
                      VDDK_TGZ="$(ls -1 "${ISO_MNT}"/assets/VMware-vix-disklib-*.tar.gz 2>/dev/null | sort | tail -n1 || true)"
                      if [[ -n "${VDDK_TGZ}" ]]; then
                          echo "[INFO] Installing VMware VDDK from asset: ${VDDK_TGZ}"
                          sudo mkdir -p /opt
                          tmp="$(mktemp -d)"
                          tar -xzf "${VDDK_TGZ}" -C "${tmp}"
                          distrib="$(find "${tmp}" -maxdepth 2 -type d \( -iname 'vmware-vix-disklib-distrib' -o -iname 'VMware-vix-disklib-distrib' \) | head -n1 || true)"
                          if [[ -z "${distrib}" ]]; then
                              distrib="$(find "${tmp}" -maxdepth 2 -type d -iname '*disklib*distrib*' | head -n1 || true)"
                          fi
                          if [[ -n "${distrib}" && -d "${distrib}" ]]; then
                              base_name="$(basename "${VDDK_TGZ}" .tar.gz)"
                              base_name="${base_name// /_}"
                              dest_versioned="/opt/${base_name}"
                              sudo rm -rf "${dest_versioned}" >/dev/null 2>&1 || true
                              sudo cp -a "${distrib}" "${dest_versioned}"
                              sudo ln -sfn "${dest_versioned}" /opt/vmware-vix-disklib-distrib
                              echo "[OK] VDDK installed to ${dest_versioned} (symlink: /opt/vmware-vix-disklib-distrib)"
                              echo "[INFO] NOTE: ablestack_v2k should pass VDDK libdir to nbdkit at runtime."

                              # write_profiled_env() from v2k_test_install.sh
                              # - DO NOT run ldconfig / DO NOT touch global linker paths
                              # - Just export default VDDK_LIBDIR for ablestack_v2k runtime
                              VDDK_LIBDIR="/opt/vmware-vix-disklib-distrib"
                              PROFILED_FILE="/etc/profile.d/v2k-vddk.sh"
                              cat <<EOP | sudo tee "${PROFILED_FILE}" >/dev/null
              # Generated by install-linux.sh (V2K add-on)
              export VDDK_LIBDIR="${VDDK_LIBDIR}"
              EOP
                              sudo chmod 0644 "${PROFILED_FILE}"
                              # best-effort source for current session (non-fatal)
                              # shellcheck disable=SC1090
                              source "${PROFILED_FILE}" || true
                              echo "[OK] Wrote VDDK_LIBDIR default to ${PROFILED_FILE}"
                          else
                              echo "[WARN] Could not locate VDDK distrib directory in ${VDDK_TGZ}"
                          fi
                          rm -rf "${tmp}"
                      else
                          echo "[WARN] VDDK asset not found: ${ISO_MNT}/assets/VMware-vix-disklib-*.tar.gz"
                      fi

                      # 4) pyvmomi (offline wheels) -> dedicated venv
                      WHEEL_DIR="${ISO_MNT}/assets/v2k/wheels"
                      if [[ -d "${WHEEL_DIR}" ]]; then
                          sudo mkdir -p /usr/share/ablestack/v2k
                          if [[ ! -d /usr/share/ablestack/v2k/venv ]]; then
                              if ! python3 -m venv /usr/share/ablestack/v2k/venv >/dev/null 2>&1; then
                                  echo "[WARN] python3 venv creation failed. Ensure python3 is installed."
                              fi
                          fi
                          if [[ -x /usr/share/ablestack/v2k/venv/bin/pip ]]; then
                              sudo /usr/share/ablestack/v2k/venv/bin/pip install --no-index --find-links "${WHEEL_DIR}" pyvmomi || true
                              echo "[OK] pyvmomi installed (offline wheels) into /usr/share/ablestack/v2k/venv"
                          else
                              echo "[WARN] venv pip not found; pyvmomi offline install skipped."
                          fi
                      else
                          echo "[WARN] pyvmomi wheels dir not found in ISO: ${WHEEL_DIR}"
                      fi
                  fi

                  ;;
              ubuntu|debian)
                  echo "[INFO] Detected DEB-based system ($DISTRO $MAJOR_VERSION)"
                  UBUNTU_DIR="${MAJOR_VERSION}.04"
                  REPO_PATH=$(realpath "$ISO_MNT/deb/deb-ubuntu${UBUNTU_DIR}")
                  LIST_FILE=/etc/apt/sources.list.d/ablestack-qemu-exec-tools.list
                  echo "deb [trusted=yes] file://$REPO_PATH stable main" | sudo tee $LIST_FILE >/dev/null
                  sudo apt-get update
                  sudo apt-get -y install ablestack-qemu-exec-tools
                  sudo rm -f /etc/apt/sources.list.d/ablestack-qemu-exec-tools.list
                  sudo apt-get update
                  ;;
              *)
                  echo "[ERROR] Unsupported distribution: $DISTRO"
                  exit 1
                  ;;
          esac

          # --- ì„¤ì¹˜ ì ˆì°¨ ë ---
          mkdir -p /var/lib/ablestack
          echo ok > /var/lib/ablestack/autoinstall.done
          echo "[INFO] Installation complete."
          EOF
          chmod +x release/install-linux.sh

      - name: Generate release notes (changelog)
        run: |
          set -e

          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          DESC="ABLESTACK VM Tools - Auto-built offline ISO for RPM (Rocky/RHEL 9,10), DEB (Ubuntu 22.04/24.04) and Windows (VirtIO Guest Tools + ablestack MSI)."

          echo "# ablestack-qemu-exec-tools ${CURRENT_TAG}" > release_notes.md
          echo >> release_notes.md
          echo "${DESC}" >> release_notes.md
          echo >> release_notes.md

          # íƒœê·¸ ì •ë³´ ë³´ê°• (í˜¹ì‹œ ëª°ë¼ì„œ)
          git fetch --tags --force || true

          # ì§ì „ íƒœê·¸ ì°¾ê¸° (ì—†ìœ¼ë©´ ìµœì´ˆ ë¦´ë¦¬ì¦ˆë¡œ ê°„ì£¼)
          PREV_TAG="$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || true)"

          if [ -z "$PREV_TAG" ]; then
            echo "## Changes" >> release_notes.md
            git log --oneline "${CURRENT_TAG}" -- . | sed 's/^/- /' >> release_notes.md
          else
            echo "## Changes since ${PREV_TAG}" >> release_notes.md
            git log --oneline "${PREV_TAG}..${CURRENT_TAG}" -- . | sed 's/^/- /' >> release_notes.md
          fi

          echo "===== Generated release_notes.md ====="
          cat release_notes.md

      - name: Generate ISO
        run: |
          VERSION=${GITHUB_REF##*/}
          mkisofs -o ablestack-qemu-exec-tools-${VERSION}.iso \
            -V "ABLESTACK-Tools" \
            -r -J release
          mkdir -p build/iso
          mv ablestack-qemu-exec-tools-${VERSION}.iso build/iso/
          ls -lh build/iso

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          files: |
            build/iso/*.iso
            release/rpm/rpm-rocky9/ablestack-qemu-exec-tools-*.rpm
            release/v2k/v2k-rpm-rocky9.6/ablestack-v2k-*.rpm
